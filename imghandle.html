<script type="text/javascript" src="led.js"></script>
<script type="text/javascript" charset="UTF-8"> 

var color_0 = '#ffffff';
var uploadImage;

function showLEDLegend() {
  
    var sel_gap = document.getElementById('Gap');
    var sel_lsize = document.getElementById('Lsize');
    var gap = parseInt(sel_gap.options[sel_gap.options.selectedIndex].value, 10);
    var lsz = parseInt(sel_lsize.options[sel_lsize.options.selectedIndex].value, 10);
  
    var sel_fsz = document.getElementById('fsize');
    var fsz = parseInt(document.getElementById('fsize').value, 10);

    makeRound = document.getElementById("round").checked;

    //var text = document.getElementById('banner_text').value;
    let text = document.getElementById("txt").value.trim();

    color_0 = document.getElementById('txtc_0').value;

    if (text.length == 0) {
      processImg();
      return;
    }


    //generateLegend(gap, lsz);
    getLEDBanner(text, fsz, gap, lsz);

}

function getLEDBanner(txt, fontsize, _s, _d) {

  maskimg = null;

  //let fontsize = 128;
  let _font = fontsize + "px Arial"; 

  side = _s;
  dots = _d;

  var tempCanvas = document.createElement("canvas");
  var tempCtx = tempCanvas.getContext("2d");

  tempCtx.font = _font;
  let fw = Math.ceil(tempCtx.measureText(txt).width) + 4;
  let fh = fontsize * 1.2;

  // set the temp canvas size == the canvas size
  tempCanvas.width = fw;
  tempCanvas.height = fh;

  //tempCtx = tempCanvas.getContext("2d");
  tempCtx.font = _font;

  //tempCtx.font = ctx.font;//fontsize + "px Arial";

  //maskimg
  initLED(0, 0, fw, fh);
  newLEDMask();
  
  tempCtx.fillStyle = 'black';
  tempCtx.fillRect(0, 0, fw, fh);
  //tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);

  tempCtx.textAlign = "left";
  

  tempCtx.fillStyle = color_0;
  tempCtx.strokeStyle = color_0;
  tempCtx.lineWidth = 4;

  tempCtx.strokeText(txt, 2, fontsize); // + '('+ _s +','+ _d +')'
  tempCtx.fillText(txt, 2, fontsize);

  maskimg.onload = function() {
    //console.log('mask generated 0! ' + maskimg.width + ', ' + maskimg.height);
    //ledAction(tempCanvas, tempCtx);
    ledAction4Still(tempCanvas, tempCtx);
    var img = document.getElementById('legend');
    img.src = tempCanvas.toDataURL();
    
  }

}

function processImg(src, des) {

  var obj = document.getElementById(src);
  uploadImage = obj;
  _processImg(des);    

}

function _processImg(des) {

  if (uploadImage == null) return; 

  var sel_gap = document.getElementById('Gap');
  var sel_lsize = document.getElementById('Lsize');
  var gap = parseInt(sel_gap.options[sel_gap.options.selectedIndex].value, 10);
  var lsz = parseInt(sel_lsize.options[sel_lsize.options.selectedIndex].value, 10);

  side = gap;
  dots = lsz;

  var tempCanvas = document.createElement("canvas");
  
  //tempCtx.font = _font;
  let fw = uploadImage.width;// Math.ceil(tempCtx.measureText(txt).width) + 4;
  let fh = uploadImage.height;
  
  let cw = (Math.floor(fw/(side + dots))) * (side + dots);
  let ch = (Math.floor(fh/(side + dots))) * (side + dots);

  // set the temp canvas size == the canvas size
  tempCanvas.width = cw;
  tempCanvas.height = ch;

  var tempCtx = tempCanvas.getContext("2d");

  //tempCtx = tempCanvas.getContext("2d");
  //tempCtx.font = _font;

  //tempCtx.font = ctx.font;//fontsize + "px Arial";

  //maskimg
  initLED(0, 0, fw, fh);
  newLEDMask();
  
  tempCtx.fillStyle = 'black';
  tempCtx.fillRect(0, 0, fw, fh);
  tempCtx.drawImage(uploadImage, 0, 0);
  //tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);

  maskimg.onload = function() {
    //console.log('mask generated 0! ' + maskimg.width + ', ' + maskimg.height);
    //ledAction(tempCanvas, tempCtx);
    ledAction4Still(tempCanvas, tempCtx);
      /*
      var _canvas = document.createElement("canvas");
      _canvas.width = tempCanvas.width/2;
      _canvas.height = tempCanvas.height/2;
      var _ctx = _canvas.getContext("2d");
      _ctx.drawImage(tempCanvas, 0, 0, tempCanvas.width/2, tempCanvas.height/2);
      */
    var img = document.getElementById(des);//'legend');
    img.src = 
    //_canvas.toDataURL();
    tempCanvas.toDataURL();
    
  }

  
}

</script>
  
  <!DOCTYPE html>
  <html>
    <head>
      <style>
        body {
          margin: 0px;
          height: 100%;
          background-color:rgb(55, 55, 55);
        }
        input[type=text] {
          width:60%;
          border:2px solid #aaa;
          border-radius: 4px;
          margin: 2% 2%;
          outline: none;
          padding: 8px;
          box-sizing: border-box;
        }
        input[type=text]:focus {
          border-color: dodgerblue;
          box-shadow: 0 0 8px 0 dodgerblue;
        }
        select {
          border:2px solid #aaa;
          border-radius: 4px;
          margin: 2% 2%;
          outline: none;
          padding: 8px;
          box-sizing: border-box;
        }
        .effect {
          filter: invert(100%); /* blur(1px) ;*/
        }
      </style>
      </head>   
  <body>
    
    <div style="margin: 2% 2%;">
      <!--input id="banner_size" type="hidden" value="128" /-->
      <img id="legend" />
    <br/>

    <label style="color:#ff0000;size: 48px;">LED Size</label>
      <select name="Lsize" id="Lsize" onchange="showLEDLegend()">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3" selected>3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
      </select> 

    <label style="color:#ff0000;size: 48px;">Gap</label>
      <select name="Gap" id="Gap" onchange="showLEDLegend()">
        <option value="0">0 Pixel</option>
        <option value="1">1</option>
        <option value="2" selected>2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
      </select>
      
      <input type="checkbox" id="round" value="0" onchange="showLEDLegend()" checked>
      <label for="cbox1" style="color:#ff0000;size: 48px;">Round</label>

      <br/>

      <br/>

      <input type="file" id="img" />

      <br/>
      <br/>

      <img id="b00" src="bg00.png"/><br/>
      <img id="b01" src="bg01.png"/><br/>
      <img id="b02" src="bg02.png"/><br/>
      <img id="b03" src="bg03.png"/><br/>
      <img id="b04" src="bg04.png"/><br/>
      <img id="b05" src="bg05.png"/><br/>
      <img id="b06" src="bg06.png"/><br/>
      <img id="b07" src="bg07.png"/><br/>
      <img id="b08" src="bg08.png"/><br/>
      <img id="b09" src="bg09.png"/><br/>
      <img id="b10" src="bg10.png"/><br/>

      <button type="button" id="imgo" style="margin: 2% 2%;width:30%;height:40px;border:2px #ff0000;" onclick="processImg('b00', 'i00')">Generate 00</button>   
      <button type="button" id="imgo" style="margin: 2% 2%;width:30%;height:40px;border:2px #ff0000;" onclick="processImg('b01', 'i01')">Generate 01</button>   
      <button type="button" id="imgo" style="margin: 2% 2%;width:30%;height:40px;border:2px #ff0000;" onclick="processImg('b02', 'i02')">Generate 02</button>   
      <button type="button" id="imgo" style="margin: 2% 2%;width:30%;height:40px;border:2px #ff0000;" onclick="processImg('b03', 'i03')">Generate 03</button>   
      <button type="button" id="imgo" style="margin: 2% 2%;width:30%;height:40px;border:2px #ff0000;" onclick="processImg('b04', 'i04')">Generate 04</button>   
      <button type="button" id="imgo" style="margin: 2% 2%;width:30%;height:40px;border:2px #ff0000;" onclick="processImg('b05', 'i05')">Generate 05</button>   
      <button type="button" id="imgo" style="margin: 2% 2%;width:30%;height:40px;border:2px #ff0000;" onclick="processImg('b06', 'i06')">Generate 06</button>   
      <button type="button" id="imgo" style="margin: 2% 2%;width:30%;height:40px;border:2px #ff0000;" onclick="processImg('b07', 'i07')">Generate 07</button>   
      <button type="button" id="imgo" style="margin: 2% 2%;width:30%;height:40px;border:2px #ff0000;" onclick="processImg('b08', 'i08')">Generate 08</button>   
      <button type="button" id="imgo" style="margin: 2% 2%;width:30%;height:40px;border:2px #ff0000;" onclick="processImg('b09', 'i09')">Generate 09</button>   
      <button type="button" id="imgo" style="margin: 2% 2%;width:30%;height:40px;border:2px #ff0000;" onclick="processImg('b10', 'i10')">Generate 10</button>   
     
      <img id="i00" /><br/>
      <img id="i01" /><br/>
      <img id="i02" /><br/>
      <img id="i03" /><br/>
      <img id="i04" /><br/>
      <img id="i05" /><br/>
      <img id="i06" /><br/>
      <img id="i07" /><br/>
      <img id="i08" /><br/>
      <img id="i09" /><br/>
      <img id="i10" /><br/>

    </div>

  </body>
  
</html>