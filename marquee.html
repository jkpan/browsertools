<script type="text/javascript" charset="UTF-8"> 

  var subtitle = [ [''], 
                   ['‰∏≠ÊñáÊ∏¨Ë©¶üöòüöñ', '2.‰∏≠Ë©¶üóø', '3.üóø']];
  
  var side = 3;
  var dots = 3;
  
  var fsize = 128;
  fsize = Math.floor(fsize/(side + dots)) * (side + dots) + side;//102;
  
  var FONT = (fsize - 4) + "px Ê®ôÊ•∑È´î";//ÈªëÈ´î-ÁπÅ";//ÂÆãÈ´î-ÁπÅ";
  var speed = 200;
  
  var initDot = 0;
  
  var dot_none = 40;
  
  var dot_rc = 255;
  var dot_gc = 255;
  var dot_bc = 255;
  
  var dot_r = 255;
  var dot_g = 255;
  var dot_b = 255;
  
  //verticle
  var jumpLine = (side + dots) * fsize * 4;
  var jumpSide = (side + dots) * 4;
  
  if (dots == 3) {
    initDot = ((side + 1) * fsize + (side + 1)) * 4;//(4 * fsize + 4) * 4;
  } else if (dots == 2) {
    initDot = ((side + 1) * fsize + (side + 1)) * 4;//(4 * fsize + 4) * 4;
  } else if (dots == 1) {
    initDot = (side * fsize + side) * 4;//(4 * fsize + 4) * 4;
  }
  
  function textGo() {
    let len = subtitle.length;
    let value = document.getElementById("txt").value;//String.fromCodePoint(0x1F604);
    if (value.length == 0) 
      return;
    subtitle[len] = [value];
    phase = len;
    switch2Marquee();
    keepGoing = 0;
    initAnim();
    ledEffect();
    
  }
  
  function emojiGo(emj) {
    let value = document.getElementById("txt").value;
    value += emj;
    document.getElementById("txt").value = value;
  }
  
  
  </script>
  
  <!DOCTYPE html>
  <html>
    <head>
      <meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8">
      <style>
        body {
          margin: 0px;
          height: 100%;
          background-color:green;
  
          /*cursor:none;*/
        }
        /*
        main {
          position: fixed;
          width: 100%;
          height: 100%;
        }
        */
        ::-webkit-scrollbar {
          display: none;
        }
        input[type=text] {
          width:60%;
          border:2px solid #aaa;
          border-radius: 4px;
          margin: 2% 2%;
          outline: none;
          padding: 8px;
          box-sizing: border-box;
        }
        input[type=text]:focus {
          border-color: dodgerblue;
          box-shadow: 0 0 8px 0 dodgerblue;
        }
      </style>
      </head>   
  <body>
  
    <div id="ui" style="margin: 2% 2%;">
      <br/>
      <!--p style="font-size:48px">&#x1f604;</p-->
      <input type="text" id="txt" name="myfield" value="‰∏≠ÊñáÊ∏¨Ë©¶" placeholder="message"/><br/>
      <button type="button" id="go" style="margin: 2% 2%;width:120px;height:40px;border:2px #ff0000;" onclick="textGo()">OK</button>
  
    </div>
  
    <canvas id="canvas" width="100" height="100" hidden="true"></canvas>
  
  </body>
  
  </html>
  
  
  <script type="text/javascript" charset="UTF-8">
  
  var canvas;
  var ctx;
  
  function init() {
      canvas = document.getElementById("canvas");
      canvas.width  = window.innerWidth;
      canvas.height = window.innerHeight;
      ctx = canvas.getContext("2d");

      jumpLine = (side + dots) * canvas.width * 4;
      jumpSide = (side + dots) * 4;

      if (dots == 3) {
        initDot = ((side + 1) * canvas.width + (side + 1)) * 4;//(4 * fsize + 4) * 4;
      } else if (dots == 2) {
        initDot = ((side + 1) * canvas.width + (side + 1)) * 4;//(4 * fsize + 4) * 4;
      } else if (dots == 1) {
        initDot = (side * canvas.width + side) * 4;//(4 * fsize + 4) * 4;
      }
  }
  
  function newParticle_txt(_p, _idx, xx, yy) {
    let p = {
            x: xx + 2,
            y: yy,
          txt: "",
            p: _p,
          idx: _idx,
   activeFlag: true,
      release: function() {
        this.txt = '';
        this.array = [];
        this.array.length = 0;
      },
  
      initial: function (c) {
        this.release();
        this.txt = subtitle[this.p][this.idx];

        this.activeFlag = true;
        
        var _ctx = c.getContext("2d");
        _ctx.font = FONT;// + "px Ê®ôÊ•∑È´î";
        return _ctx.measureText(this.txt).width;
      },
  
      update: function (c, _ctx, dt) {
          
        //console.log(this.y);
        if (!this.activeFlag) return;//= true;
  
        if (dt > 1000) dt = 16;
  
        this.x -= dt * 0.001 * speed;//dt * 0.001 * (dots + side) * 2;
  
        if (this.x < -_ctx.measureText(this.txt).width + 10) {
          this.activeFlag = false;
          return;
        }

        if (this.x > c.width + fsize)
          return; 

  
        _ctx.textAlign = "left";
        _ctx.font = FONT;// + "px Ê®ôÊ•∑È´î";
        
        _ctx.strokeStyle = 'white';
        _ctx.lineWidth = 4;
          
        _ctx.fillStyle = 'white';

        _ctx.strokeText(this.txt, this.x, this.y);
        _ctx.fillText(this.txt, this.x, this.y);
  
      }
    }
    return p;
  }
  
  function anim_update(elapse) {
  
    //ctx.clearRect(0, 0, canvas.width, canvas.height);
  
    ctx.fillStyle = 'black';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  
    let dt = elapse - pre;
    pre = elapse;
  
    if (keepGoing == 1) {
      
      if (maskimg) {
        
        //ctx.fillStyle = 'black';
        //verticle
        //ctx.fillRect(0, 0, canvas.width, canvas.height);
        //ctx.fillRect(0, 0, canvas.width, fsize + 9);
      }
      
      for (var i = 0;i<particles.length;i++) {
          particles[i].update(canvas, ctx, dt);
      }
  
      /*
      //verticle
      if (particles[particles.length - 1].activeFlag == false) { //
        let yy = canvas.height + fsize;
        for (var i = 0;i<particles.length;i++) {
          let txtlen = particles[i].initial(canvas);
          particles[i].y = yy;
          yy += (txtlen + 2) * fsize;
        }
      }
      */
      
      if (particles[particles.length - 1].activeFlag == false) { //
        let xx = canvas.width;
        for (var i = 0;i<particles.length;i++) {
          let txtlen = particles[i].initial(canvas);
          particles[i].x = xx;
          xx += txtlen + 2 * fsize;
        }
      }
      
  
      if (maskimg) {
          
          //verticle
          //ctx.drawImage(maskimg, fsize, 0);
          //let mask = ctx.getImageData(fsize, 0, fsize, canvas.height);
          
          ctx.drawImage(maskimg, 0, 0);
          let mask = ctx.getImageData(0, 0, canvas.width, canvas.height);
          
          var data = mask.data;
          //verticle
          //let gapL = fsize * 4;
          let gapL = canvas.width * 4;
  
          let gapP = 4;
          //verticle
          //let wid = fsize;
          let wid = canvas.width;
  
          let _r = dot_r * Math.random();
          let _g = dot_g * Math.random();
          let _b = dot_b * Math.random();
  
          let _rc = dot_rc * Math.random();
          let _gc = dot_gc * Math.random();
          let _bc = dot_bc * Math.random();
                  
          for (let i = initDot;i < data.length;i += jumpLine) {
          
            let pix = i/4;
            let h = Math.floor(pix/wid);
            let w = pix%wid;
          
            for (let k = i;;k+=jumpSide) {
              let _pix = k/4;
              let _h = Math.floor(_pix/wid);
              let _w = _pix%wid;
              if (_h != h) 
                break;
              
              _r = data[k];
              _g = data[k+1];
              _b = data[k+2];
  
              _rc = data[k];
              _gc = data[k+1];
              _bc = data[k+2];
              
  
              if ((data[k] > dot_none/2 || data[k+1] > dot_none/2 || data[k+2] > dot_none/2)) {
              //if (data[k] > 127 || data[k+1] > 127 || data[k+2] > 127) {
              //if (data[k] > 100) {// + data[k+1] + data[k+2] > 300) {
                  
                  setPixColor(data, k, _r, _g, _b);//‰∏≠
                  
                  if (dots == 1) continue;
  
                  setPixColor(data, k - gapP, _r, _g, _b);//Â∑¶
                  setPixColor(data, k - gapL, _r, _g, _b);//‰∏ä
                  setPixColor(data, k - gapP - gapL, _rc, _gc, _bc);//Â∑¶‰∏ä
  
                  if (dots == 2) continue;
  
                  //Âè≥
                  let idx = k + gapP;
                  let pp = idx/4;
                  let hh = Math.floor(pp/wid);
                  let ww = pp%wid;
                  if (hh == _h) {
                    //Âè≥
                    setPixColor(data, idx, _r, _g, _b);
                    //Âè≥‰∏ä
                    setPixColor(data, idx - gapL, _rc, _gc, _bc);
                                      
                    idx = k + gapP + gapL;
                    pp = idx/4;
                    hh = Math.floor(pp/wid);
                    ww = pp%wid;
                    if (idx < data.length) {
                      //Âè≥‰∏ã
                      setPixColor(data, idx, _rc, _gc, _bc);
                      //‰∏ã
                      setPixColor(data, k + gapL, _r, _g, _b);
                      //Â∑¶‰∏ã
                      setPixColor(data, k - gapP + gapL, _rc, _gc, _bc);
                      
                    }
                  }
              } else {
                  
                  setPixColor(data, k, dot_none, dot_none, dot_none);//‰∏≠
                  
                  if (dots == 1) continue;
  
                  setPixColor(data, k - gapP, dot_none, dot_none, dot_none);//Â∑¶
                  setPixColor(data, k - gapL, dot_none, dot_none, dot_none);//‰∏ä
                  setPixColor(data, k - gapP - gapL, dot_none, dot_none, dot_none);//Â∑¶‰∏ä
                  
                  if (dots == 2) continue;
  
                  
                  let idx = k + gapP;
                  let pp = idx/4;
                  let hh = Math.floor(pp/wid);
                  let ww = pp%wid;
                  if (hh == _h) {
  
                    setPixColor(data, idx, dot_none, dot_none, dot_none);//Âè≥
                    setPixColor(data, idx - gapL, dot_none, dot_none, dot_none);//Âè≥‰∏ä
                                    
                    idx = k + gapP + gapL;
                    pp = idx/4;
                    hh = Math.floor(pp/wid);
                    ww = pp%wid;
                    if (idx < data.length) {
                      
                      setPixColor(data, idx, dot_none, dot_none, dot_none);//Âè≥‰∏ã
                      setPixColor(data, k + gapL, dot_none, dot_none, dot_none);//‰∏ã
                      setPixColor(data, k - gapP + gapL, dot_none, dot_none, dot_none);//Â∑¶‰∏ã
                      
                    }
                  }
                  
              }
            }
        }
        //verticle
        //ctx.putImageData(mask, fsize, 0);
        ctx.putImageData(mask, 0, 0);
        
      }
      //
      
      window.requestAnimationFrame(anim_update);
  
    } else {
      if (phase != 0) {
        initAnim();
      }
    }
  
  }
  
  function setPixColor(data, idx, r, g, b) {
    data[idx]     = r;
    data[idx + 1] = g;
    data[idx + 2] = b;
    data[idx + 3] = 255;
  }
  
  function initAnim() {
  
    keepGoing = 0;
    if (phase == 0) {
        return;
    }
  
    var c = document.getElementById("canvas");
    var ctx = c.getContext("2d");
  
    //console.log(c.width + ', ' + c.height);
    
    if (particles.length >= 1) {
      for (var i = 0;i<particles.length;i++) {
        particles[i].release();
      }
    }
  
    particles.length = 0;
    particles = [];
  
    /*
    //verticle
    let xx = fsize;
    let yy = c.height + fsize;
    let _idx = 0;
    var total = subtitle[phase].length;//Math.min(35, 15 + 5 * Math.floor(c.width/500));//console.log('total:'+total);
    for (_idx = 0;_idx<total;_idx++) {
        particles[_idx] = newParticle_txt(phase, _idx,  xx, yy);//();
        let txtlen = particles[_idx].initial(c);
        yy += (txtlen + 2) * fsize;
    }
    */

    let yy = c.height/2.0;
    let xx = c.width + fsize;
    var total = subtitle[phase].length;//Math.min(35, 15 + 5 * Math.floor(c.width/500));//console.log('total:'+total);
    for (let _idx = 0;_idx<total;_idx++) {
      particles[_idx] = newParticle_txt(phase, _idx,  xx, yy);//();
      let txtlen = particles[_idx].initial(c);
      xx += (txtlen + fsize);
    }
  
    keepGoing = 1;
    window.requestAnimationFrame(anim_update);
  
  }
  
  function doresize() {
    init();
    //initAnim();
    if (maskimg != null) {
      ledEffect();
    }
  }
  
  function generateMask(w, h, s, d) {
  
    var mask = ctx.createImageData(w, h);
    var data = mask.data;
  
    for (let y = 0; y < h; y++) {
      for (let x = 0; x < w; x++) {
  
          let idx = (y * w + x) * 4;
  
          data[idx + 0] = 0;//40;
          data[idx + 1] = 0;//40;
          data[idx + 2] = 0;//40;
          data[idx + 3] = 255;
          
          let _x = x%(s + d);
          let _y = y%(s + d);
          if (_x >= s && _y >= s) { //d
            data[idx + 3] = 0;
          }
  
      }
    }
  
    return mask;
  
  }
  
  
  var maskimg;
  
  function ledEffect() {
    
    //verticle
    //let w = fsize;
    //let h = canvas.height;
  
    let w = canvas.width;
    let h = canvas.height;
  
    var mask = generateMask(w, h, side, dots);
          
      // create a temporary canvas
      var tempCanvas = document.createElement("canvas");
      var tempCtx = tempCanvas.getContext("2d");
  
      // set the temp canvas size == the canvas size
      tempCanvas.width = w;
      tempCanvas.height = canvas.height;
  
      // put the modified pixels on the temp canvas
      tempCtx.putImageData(mask, 0, 0);
  
      // use the tempCanvas.toDataURL to create an img object
      maskimg = new Image();
      //maskimg.onload = function() {}
      maskimg.src = tempCanvas.toDataURL();
  
  }
  
  var phase = 0;
  var keepGoing = 1;
  
  var pre = 0;
  var particles = [];
  var doblank = 0;
  
  function react() {
    if (maskimg != null) {
      ledEffect();
    }
  }
  
  function keyboard(e) {
  
      if (canvas.hidden) return; 
  
      switch (e.keyCode) {
          case 76: //'l'
              if (maskimg != null) {
                maskimg = null;
              } else {
                ledEffect();
              }
              break;
          case 66: //'b'
              doblank = doblank == 0?1:0;
              break;
          case 38: //'ArrowUp'
              speed += 20;
              break; 
          case 40: //'ArrowDown':
              speed -= 20;
              //if (speed < 10) speed = 0;
              break;
          case 37: //'ArrowLeft'
              break; 
          case 39: //'ArrowRight'
              break;
          case 48:    case 49:  case 50:  case 51:  case 52:  case 53:  case 54:  case 55:  case 56:  case 57: {
          //case '0': case '1': case '2': case '3': case '4': case '5': case '6': case '7': case '8': case '9':
              var value = e.keyCode - 48;
              if (value > subtitle.length - 1)
                  break;
              
              phase = value;
              if (keepGoing == 0) {
                initAnim();
              } else {
                keepGoing = 0;
              }
  
          }
          break;
          case 73: //i
            //inputTxt();
            if (canvas.hidden == false) {
              switch2Input();
            } else {
              switch2Marquee();
            }
            break;
              
              
      }
  
  }
  
  
  function switch2Input() {
    keepGoing = 0;
    var div = document.getElementById('ui');
    if (div) {
      div.hidden = false;
      canvas.hidden = true;
    }
    
  }
  
  function switch2Marquee() {
    var div = document.getElementById('ui');
    if (div) {
      div.hidden = true;
      canvas.hidden = false;
    }
  }
  
  init();
  
  window.addEventListener('resize', doresize);
  //window.addEventListener('click', initAnim, false);
  //document.getElementsByTagName("canvas")[0].addEventListener("touchend", initAnim, false);
  window.addEventListener('keyup', keyboard, false);
  
  if (subtitle.length > 1 && subtitle[1].length > 0) {
    phase = 1;
    initAnim();
    ledEffect();
  }
  
  /*
  function removeDiv() {
    var buttons = document.getElementById('btns');
    if (buttons) {
      document.body.removeChild(buttons);
    } 
    return;
  }
  
  function inputTxt() {
    
    canvas.hidden = true;
    removeDiv();
    
    var div = document.createElement('div');
    div.id = 'btns';  
    document.body.appendChild(div);
  
    var input = document.createElement("input");
    input.type = "text";
    input.id = 'banner';
    div.appendChild(input);
  
    var button = document.createElement('button');
    button.innerHTML = 'OK';
    button.id = 'okgo';
    button.onclick = function() {
      return false;
    };
    div.appendChild(button);
  }
  */
  
  </script>
  