<script type="text/javascript" src="led.js"></script>
<script type="text/javascript" charset="UTF-8"> 

  var subtitle = [ [''], 
                   [''],
                   ['']];
    
  var fsize = 128;
  var fontFamily = "標楷體";
  
  var FONT = fsize + "px 標楷體";//黑體-繁";//宋體-繁";
  var speed = 160;
  var speed1 = 160;

  var animIdx = 0;

  var color_0 = '#ffffff';
  var color_1 = '#ffffff';

  var swing = 0;
  var swing1 = 0;

  function _textGo(_id, idx) {

    let value = document.getElementById(_id).value.trim();//String.fromCodePoint(0x1F604);
    if (value.length == 0) 
      return false;
    
    subtitle[idx] = [value];
    phase = idx;
    return true;

  }

  function textGo() {
    let txt1 = document.getElementById("txt").value.trim();
    let txt2 = document.getElementById("txt2").value.trim();
    if (txt1.length + txt2.length > 0) {
      subtitle[1] = [txt1];
      subtitle[2] = [txt2];
      
      var sel_gap = document.getElementById('Gap');
      var sel_lsize = document.getElementById('Lsize');
      var gap = parseInt(sel_gap.options[sel_gap.options.selectedIndex].value, 10);
      var lsz = parseInt(sel_lsize.options[sel_lsize.options.selectedIndex].value, 10);

      side = gap;
      dots = lsz;

      var slider = document.getElementById('speed');
      speed = parseInt(slider.value, 10);
      var slider1 = document.getElementById('speed1');
      speed1 = parseInt(slider1.value, 10);
      
      var sel_anim = document.getElementById('anim');
      animIdx = parseInt(sel_anim.options[sel_anim.options.selectedIndex].value, 10);

      color_0 = document.getElementById('txtc_0').value;
      color_1 = document.getElementById('txtc_1').value;
      
      if (document.getElementById("swing").checked) {
        swing = 1;
      } else {
        swing = 0;
      }

      if (document.getElementById("swing1").checked) {
        swing1 = 1;
      } else {
        swing1 = 0;
      }

      /*
      var sel_anim = document.getElementById('anim');
      for(var i = 0; i < sel_anim.options.length; ++i) {
        if (parseInt(sel_anim.options[i].value, 10)  === animIdx) {
          sel_anim.selectedIndex = i;
          break;
        }
      }
      */

      switch2Marquee();
      
      init();
      initAnim();

    }
  }
  
  function emojiGo(emj) {
    let value = document.getElementById("txt").value;
    value += emj;
    document.getElementById("txt").value = value;
  }
  
  function sync2ui() { //selOption() {

    var sel_gap = document.getElementById('Gap');
    for(var i = 0, j = sel_gap.options.length; i < j; ++i) {
        if (parseInt(sel_gap.options[i].value, 10)  === side) {
          sel_gap.selectedIndex = i;
          break;
        }
    }
    var sel_lsize = document.getElementById('Lsize');
    for(var i = 0, j = sel_lsize.options.length; i < j; ++i) {
        if (parseInt(sel_lsize.options[i].value, 10)  === dots) {
          sel_lsize.selectedIndex = i;
          break;
        }
    }

    var slider = document.getElementById('speed');
    slider.value = speed;
    slider = document.getElementById('speed1');
    slider.value = speed1;
    
    showLEDLegend();
     
    
  }

  function showLEDLegend() {
  
    var sel_gap = document.getElementById('Gap');
    var sel_lsize = document.getElementById('Lsize');
    var gap = parseInt(sel_gap.options[sel_gap.options.selectedIndex].value, 10);
    var lsz = parseInt(sel_lsize.options[sel_lsize.options.selectedIndex].value, 10);
  
    var size = parseInt(document.getElementById('banner_size').value, 10)
    var text = document.getElementById('banner_text').value;
    
    
    //generateLegend(gap, lsz);
    getLEDBanner(text, size, gap, lsz);

  }

function getLEDBanner(txt, fontsize, _s, _d) {

  maskimg = null;

  //let fontsize = 128;
  let _font = fontsize + "px Arial"; 

  side = _s;
  dots = _d;

  var tempCanvas = document.createElement("canvas");
  var tempCtx = tempCanvas.getContext("2d");

  tempCtx.font = _font;
  let fw = Math.ceil(tempCtx.measureText(txt).width) + 4;
  let fh = fontsize * 1.2;

  // set the temp canvas size == the canvas size
  tempCanvas.width = fw;
  tempCanvas.height = fh;

  //tempCtx = tempCanvas.getContext("2d");
  tempCtx.font = _font;

  //tempCtx.font = ctx.font;//fontsize + "px Arial";

  //maskimg
  initLED(0, 0, fw, fh);
  newLEDMask();
  
  tempCtx.fillStyle = 'black';
  tempCtx.fillRect(0, 0, fw, fh);

  tempCtx.textAlign = "left";
  

  tempCtx.fillStyle = 'yellow';
  tempCtx.strokeStyle = 'yellow';
  tempCtx.lineWidth = 4;

  tempCtx.strokeText(txt, 2, fontsize); // + '('+ _s +','+ _d +')'
  tempCtx.fillText(txt, 2, fontsize);

  maskimg.onload = function() {
    //console.log('mask generated 0! ' + maskimg.width + ', ' + maskimg.height);
    ledAction(tempCanvas, tempCtx);
    var img = document.getElementById('legend');
    img.src = tempCanvas.toDataURL();
    
  }

}

</script>
  
  <!DOCTYPE html>
  <html>
    <head>
      <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" charset="UTF-8"/>
      <!--meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8"-->
      <style>
        body {
          margin: 0px;
          height: 100%;
          background-color:black;
  
          /*cursor:none;*/
        }
        /*
        main {
          position: fixed;
          width: 100%;
          height: 100%;
        }
        */
        ::-webkit-scrollbar {
          display: none;
        }
        input[type=text] {
          width:60%;
          border:2px solid #aaa;
          border-radius: 4px;
          margin: 2% 2%;
          outline: none;
          padding: 8px;
          box-sizing: border-box;
        }
        input[type=text]:focus {
          border-color: dodgerblue;
          box-shadow: 0 0 8px 0 dodgerblue;
        }
        select {
          border:2px solid #aaa;
          border-radius: 4px;
          margin: 2% 2%;
          outline: none;
          padding: 8px;
          box-sizing: border-box;
        }
        .slider {
          -webkit-appearance: none;  /* Override default CSS styles */
          appearance: none;
          width: 100%; /* Full-width */
          height: 25px; /* Specified height */
          background: #d3d3d3; /* Grey background */
          outline: none; /* Remove outline */
          opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */
          -webkit-transition: .2s; /* 0.2 seconds transition on hover */
          transition: opacity .2s;
        }
          /*
        canvas {
              padding-left: 0;
              padding-right: 0;
              margin-left: 0;
              margin-right: 0;
              display: block;
        }
          */
          input[type=range]::-webkit-slider-runnable-track {
            width: 300px;
            height: 5px;
            background: #ddd;
            border: none;
            border-radius: 3px;
          }

          input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            border: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: goldenrod;
            margin-top: -4px;
          }

          
          .column {
            float: left;
            width: 50%;
          }
          .row:after {
            content: "";
            display: table;
            clear: both;
          }
          /*
          .row {
            display: flex;
          }

          .column {
            flex: 50%;
          }
          */
      </style>
      </head>   
  <body>

    
    <div class="row" id="ui" style="margin: 2% 2%;">
      <div style="background-color:#000000;">  
        <input id="banner_size" type="hidden" value="96" />
        <input id="banner_text" type="hidden" value="LED-Board😎" />
        <img id="legend" />
      </div>
      <label style="color:#ff0000;size: 48px;">LED Size</label>
        <select name="Lsize" id="Lsize" onchange="showLEDLegend()">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
        </select> 
      <label style="color:#ff0000;size: 48px;">Gap</label>
        <select name="Gap" id="Gap" onchange="showLEDLegend()">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
        </select>

        

      <br/>
      <div class="column" style="background-color:#555555;">

        <br/>

        <input type="text" id="txt" name="myfield" value="🎉Merry Christmas🎄" placeholder="message"/>
        
        <br/>
        
          <label style="color:#ff0000;size: 48px;">Color</label>
          <input type="color" id="txtc_0" value="#ffffff">
          
          <label style="color:#ff0000;size: 48px;">Speed</label>
          <input type="range" min="20" max="400" step="20" value="120" id="speed" onchange=""/>

          <input type="checkbox" id="swing" value="0" checked>
          <label for="cbox1" style="color:#ff0000;size: 48px;">Swing</label>
        
        <br/>
        <hr/>

        <input type="text" id="txt2" name="myfield" value="⛪️台北市中心神召會🔔" placeholder="message"/> <!--Hello🌏-->
        
        <br/>

          <label style="color:#ff0000;size: 48px;">Color</label>
          <input type="color" id="txtc_1" value="#ffffff">

          <label style="color:#ff0000;size: 48px;">Speed</label>
          <input type="range" min="20" max="400" step="20" value="120" id="speed1" onchange=""/>

          <input type="checkbox" id="swing1" value="0" checked>
          <label for="cbox1" style="color:#ff0000;size: 48px;">Swing</label>
          
        <br/>
        <hr/>

        <label style="color:#ff0000;size: 48px;">Animation background</label>
        <select name="anim" id="anim">
          <option value="0" selected>none</option>
          <option value="1">ring</option>
          <option value="2">in</option>
          <option value="3">out</option>
          <option value="4">inout</option>
          <option value="5">doughnut</option>
          <option value="6" selected>snow</option>
          <option value="7">firework</option>
          <option value="8">clock</option>
        </select>

        <br/>        
            
      </div>
      <div class="column">
        <button type="button" id="go" style="font-size: 24px;background-color:#fa5252;margin: 2% 2%;width:40%;height:100px;border:2px #ff0000;" onclick="textGo()">START</button>
      </div>
    </div>
  
  
      
      

    <!--a onclick="emojiGo('😀')">😀</a><a onclick="emojiGo('😆')">😆</a>
    <a onclick="emojiGo('😅')">😅</a><a onclick="emojiGo('😂')">😂</a>
    <a onclick="emojiGo('🤣')">🤣</a><a onclick="emojiGo('🥲')">🥲</a>
    <a onclick="emojiGo('😍')">😍</a><a onclick="emojiGo('😋')">😋</a> 
    <a onclick="emojiGo('😜')">😜</a><a onclick="emojiGo('😎')">😎</a> 
    <a onclick="emojiGo('😔')">😔</a><a onclick="emojiGo('😢')">😢</a> 
    <a onclick="emojiGo('😭')">😭</a><a onclick="emojiGo('😡')">😡</a>
    <a onclick="emojiGo('😳')">😳</a><a onclick="emojiGo('😱')">😱</a> 
    <a onclick="emojiGo('😨')">😨</a><a onclick="emojiGo('😵')">😵</a> 
    <a onclick="emojiGo('🤢')">🤢</a><a onclick="emojiGo('🤮')">🤮</a> 
    <a onclick="emojiGo('🤧')">🤧</a><a onclick="emojiGo('😷')">😷</a> 
    <a onclick="emojiGo('🤒')">🤒</a><a onclick="emojiGo('🤕')">🤕</a> 
    <a onclick="emojiGo('💩')">💩</a><a onclick="emojiGo('👻')">👻</a> 
    <a onclick="emojiGo('💀')">💀</a><a onclick="emojiGo('👽')">👽</a> 
    <a onclick="emojiGo('🤖')">🤖</a--> 
  
  
    <canvas id="canvas" width="100" height="100" hidden="true"></canvas>
  
  </body>
  
  </html>
  
  
<script type="text/javascript" charset="UTF-8">


  var canvas;
  var ctx;

  function initCanvas() {
    canvas = document.getElementById("canvas");
    canvas.width  = window.outerWidth;
    canvas.height = window.outerHeight;
    ctx = canvas.getContext("2d");
  }

  function init() {

    initCanvas();

    initLED(0, 0, canvas.width, canvas.height);
    newLEDMask();

  }

  
  function newParticle_swingtxt(_txt, xx, yy) {
    let p = {
            x: xx,
            y: yy,
          txt: _txt,
         step: 0,
          len:0,
        color:'#ffffff',
        speed:4.0,
      release: function() {
        this.txt = '';
      },
      sinoutin: function(t) { // 0-1  15 * sinoutin(recoil_t * 1.0/8.0);
        if (t < 0.5) return 2 * t;
        return  -2 * t + 2;//Math.sin(t * Math.PI);//- (t-1) * (t-1) +1 ;
      },
      stepValue: function(peroidSec, range, dt) { //(float &_step, float peroidSec, float range, float dt) {
        this.step += dt/peroidSec;
        if (this.step > 1.0) {
          this.step = 0.0;
        }
        return this.sinoutin(this.step) * range;
      },
      initial: function (c) {
        this.step = 0;
        var _ctx = c.getContext("2d");
        _ctx.font = FONT;// + "px 標楷體";
        this.len = _ctx.measureText(this.txt).width;
        return this.len;
      },
  
      update: function (c, _ctx, dt) {
         
        if (dt > 1000) dt = 16;
        
        dt *= 0.001;

        this.x = (c.width - this.len) - this.stepValue(this.speed, (c.width - this.len), dt);

        //this.x -= dt * 0.001 * speed;//dt * 0.001 * (dots + side) * 2;
  
        _ctx.textAlign = "left";
        _ctx.font = FONT;// + "px 標楷體";
        
        _ctx.strokeStyle = this.color;//'white';
        _ctx.lineWidth = 4;
          
        _ctx.fillStyle = this.color;//'white';

        _ctx.strokeText(this.txt, this.x, this.y);
        _ctx.fillText(this.txt, this.x, this.y);
  
      }
    }
    return p;
  }
  

  function newParticle_txt(_txt, xx, yy) {
    let p = {
            x: xx,
            y: yy,
          txt: _txt,
        color:'#ffffff',
        speed:160,
      release: function() {
        this.txt = '';
      },
      initial: function (c) {
        //this.release();
        //this.txt = subtitle[this.p][this.idx];
        var _ctx = c.getContext("2d");
        _ctx.font = FONT;// + "px 標楷體";
        return _ctx.measureText(this.txt).width;
      },
  
      update: function (c, _ctx, dt) {
         
        if (dt > 1000) dt = 16;
  
        this.x -= dt * 0.001 * this.speed;//dt * 0.001 * (dots + side) * 2;
         
        if (this.x < -_ctx.measureText(this.txt).width + 10) {
          this.x = c.width;
          return;
        }
          
        _ctx.textAlign = "left";
        _ctx.font = FONT;// + "px 標楷體";
        
        _ctx.strokeStyle = this.color;//color_0;//'white';
        _ctx.lineWidth = 4;
          
        _ctx.fillStyle = this.color;//color_0;//'white';

        _ctx.strokeText(this.txt, this.x, this.y);
        _ctx.fillText(this.txt, this.x, this.y);
  
      }
    }
    return p;
  }
  
  function anim_update(elapse) {
  
    //ctx.clearRect(0, 0, canvas.width, canvas.height);
  
    ctx.fillStyle = 'black';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  
    let dt = elapse - pre;
    pre = elapse;
  
    /*
    if (keepGoing != 1) {
      initAnim();
      return;
    }
    */

    for (var i = 0;i<particlesBG.length;i++) {
      particlesBG[i].update(canvas, ctx, dt);
    }

    for (var i = 0;i<particles.length;i++) {
      particles[i].update(canvas, ctx, dt);
    }
     
    if (keepLEDGoing == 1) {
      ledAction(canvas, ctx);
    }
    
    if (keepGoing == 1) {
      window.requestAnimationFrame(anim_update);
      //console.log("requestAnimationFrame update " + elapse);
    }
  
  }
  
  function initAnim() {
  
    keepGoing = 0;

    if (subtitle.length == 1) 
      return;

    var c = document.getElementById("canvas");
    var ctx = c.getContext("2d");
  
    //console.log(c.width + ', ' + c.height);
    
    if (particles.length >= 1) {
      for (var i = 0;i<particles.length;i++) {
        particles[i].release();
      }
    }

    particles.length = 0;
    particles = [];
  
    //for (let _i = 1;_i<subtitle.length;_i++) {}
    //let yy = c.height/4.0 + fsize/2;
    
    fsize = canvas.height/3;
    FONT = fsize + "px " + fontFamily;
    let xx = c.width;

    //var total = subtitle[1].length;//Math.min(35, 15 + 5 * Math.floor(c.width/500));//console.log('total:'+total);
    if (subtitle[2][0].length > 0) {
      if (swing == 0) {
        particles[0] = newParticle_txt(subtitle[1][0], xx, 0.5 * c.height - fsize/5);//();
        particles[0].speed = speed;
      } else {
        particles[0] = newParticle_swingtxt(subtitle[1][0], xx, 0.5 * c.height - fsize/5);//();
        particles[0].speed = 7 - speed/100.0;
      }
      particles[0].initial(c);
      particles[0].color = color_0;
      if (swing1 == 0) {
        particles[1] = newParticle_txt(subtitle[2][0], xx, 0.5 * c.height + fsize);//();
        particles[1].speed = speed1;
      } else {
        particles[1] = newParticle_swingtxt(subtitle[2][0], xx, 0.5 * c.height + fsize);//();
        particles[1].speed = 7 - speed1/100.0;
      }
      
      particles[1].initial(c);
      particles[1].color = color_1;

    } else {
      fsize = canvas.height/2;
      FONT = fsize + "px " + fontFamily;
      if (swing == 0) {
        particles[0] = newParticle_txt(subtitle[1][0], xx, 0.5 * c.height + fsize/3);//();
        particles[0].speed = speed;
      } else {
        particles[0] = newParticle_swingtxt(subtitle[1][0], xx, 0.5 * c.height + fsize/3);//();
        particles[0].speed = 7 - speed/100.0;;
      }

      particles[0].initial(c);
      particles[0].color = color_0;
    }
    
    if (particlesBG.length >= 1) {
      for (var i = 0;i<particlesBG.length;i++) {
        particlesBG[i].release();
      }
    }

    particlesBG.length = 0;
    particlesBG = [];

    switch (animIdx) {
      case 0:break;
      case 1:
        for (var i = 0;i<150;i++) {
          particlesBG[i] = newParticle_casual();
          particlesBG[i].initial(canvas);
        }
        break;
      case 2:
        for (var i = 0;i<150;i++) {
          particlesBG[i] = newParticle_in();
          particlesBG[i].initial(canvas);
        }
        break;
      case 3:
        for (var i = 0;i<150;i++) {
          particlesBG[i] = newParticle_out();
          particlesBG[i].initial(canvas);
        }
        break;
      case 4:
        for (var i = 0;i<150;i++) {
          if (Math.random() > 0.5)  
            particlesBG[i] = newParticle_in();
          else 
            particlesBG[i] = newParticle_out();
          particlesBG[i].initial(canvas);
        }
        break;
      case 5:
        for (var i = 0;i<150;i++) {
          particlesBG[i] = newParticle_ring();
          particlesBG[i].initial(canvas);
        }
        break;
      case 6:
        for (var i = 0;i<150;i++) {
          particlesBG[i] = newParticle_snow();
          particlesBG[i].initial(canvas);
        }
        break;
      case 7:
        for (var i = 0;i<3;i++) {
          particlesBG[i] = newParticle_firework();
          particlesBG[i].initial(canvas);
        }
        break;
      case 8:
        particlesBG[0] = newClock();
        particlesBG[0].initial(canvas);
        break;
        
    }

    keepGoing = 1;
    window.requestAnimationFrame(anim_update);
  
  }

  var phase = 0;
  var keepGoing = 1;
  var keepLEDGoing = 1;
  
  var pre = 0;
  var particles = [];
  var particlesBG = [];
  var doblank = 0;

  function ledSwitch() {
    keepLEDGoing = keepLEDGoing == 0?1:0;
  }
  
  function keyboard(e) {
  
      if (canvas.hidden) return; 
  
      switch (e.keyCode) {
          case 76: //'l'
              ledSwitch();
              break;
          case 66: //'b'
              doblank = doblank == 0?1:0;
              break;
          case 38: //'ArrowUp'
              speed += 20;
              break; 
          case 40: //'ArrowDown':
              speed -= 20;
              //if (speed < 10) speed = 0;
              break;
          case 37: //'ArrowLeft'
              break; 
          case 39: //'ArrowRight'
              break;
          case 73: //i
            //inputTxt();
            if (canvas.hidden == false) {
              switch2Input();
            } else {
              switch2Marquee();
            }
            break;
          case 32: canvas.requestFullscreen(); break;

              
      }
  
  }
  
  
  function switch2Input() {
    
    keepGoing = 0;

    sync2ui();
    var div = document.getElementById('ui');
    if (div) {
      div.hidden = false;
      canvas.hidden = true;
    }
    
  }
  
  function switch2Marquee() {
    var div = document.getElementById('ui');
    if (div) {
      div.hidden = true;
      canvas.hidden = false;
    }
  }


  function getTouchPos(canvasDom, touchEvent) {
    var rect = canvasDom.getBoundingClientRect();
    return { x: touchEvent.touches[0].clientX - rect.left,
             y: touchEvent.touches[0].clientY - rect.top};
  }

  initCanvas();
  switch2Input();

  window.addEventListener('keyup', keyboard, false);
  window.addEventListener('resize', function() {
    if (canvas.hidden) 
      return;
    init();
  });

  document.getElementsByTagName("canvas")[0].addEventListener("touchstart", function(evt) {
          //canvas.requestFullscreen();

          if (canvas.hidden) return;

          evt.preventDefault();
          var touches = getTouchPos(canvas, evt);

          if (touches.x > canvas.width/2 && touches.y > canvas.height/2) { //右下
              switch2Input();
              return;
          }
          if (touches.x < canvas.width/2 && touches.y > canvas.height/2) { //左下
              canvas.requestFullscreen();
              return;
          }
          if (touches.x > canvas.width/2 && touches.y < canvas.height/2) { //右上
              ledSwitch();
          }
          if (touches.x < canvas.width/2 && touches.y < canvas.height/2) { //左上

          }

        });

</script>

<script type="text/javascript" src="marquee_anim.js" charset="UTF-8"></script>
