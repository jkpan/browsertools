<script type="text/javascript" charset="UTF-8"> 

  var subtitle = [ [''], 
                   [''],
                   ['']];
  
  var side = 3;
  var dots = 7;
  
  var fsize = 128;
  var fontFamily = "標楷體";
  
  var FONT = fsize + "px 標楷體";//黑體-繁";//宋體-繁";
  var speed = 80;
  
  var initDot = 0;
  
  var dot_none = 33;
  var criteria = dot_none * 2 / 3;//dot_none/2;
  
  var dot_rc = 255;
  var dot_gc = 255;
  var dot_bc = 255;
  
  var dot_r = 255;
  var dot_g = 255;
  var dot_b = 255;
  
  //verticle
  var jumpLine = (side + dots) * fsize * 4;
  var jumpSide = (side + dots) * 4;
  
  if (dots == 3) {
    initDot = ((side + 1) * fsize + (side + 1)) * 4;//(4 * fsize + 4) * 4;
  } else if (dots == 2) {
    initDot = ((side + 1) * fsize + (side + 1)) * 4;//(4 * fsize + 4) * 4;
  } else if (dots == 1) {
    initDot = (side * fsize + side) * 4;//(4 * fsize + 4) * 4;
  }

  var maskWidth = 100;
  var maskHeight = 100;

  var gapL = 0;
  var gapP = 0;
  
  function _textGo(_id, idx) {
    let value = document.getElementById(_id).value.trim();//String.fromCodePoint(0x1F604);
    if (value.length == 0) 
      return false;
    
    subtitle[idx] = [value];
    phase = idx;
    return true;
  }

  function textGo() {
    let txt1 = document.getElementById("txt").value.trim();
    let txt2 = document.getElementById("txt2").value.trim();
    if (txt1.length + txt2.length > 0) {
      subtitle[1] = [txt1];
      subtitle[2] = [txt2];
      
      
      var sel_gap = document.getElementById('Gap');
      var sel_lsize = document.getElementById('Lsize');
      var gap = parseInt(sel_gap.options[sel_gap.options.selectedIndex].value, 10);
      var lsz = parseInt(sel_lsize.options[sel_lsize.options.selectedIndex].value, 10);

      side = gap;
      dots = lsz;

      var slider = document.getElementById('speed');
      speed = parseInt(slider.value, 10);
      
      switch2Marquee();
      //keepGoing = 0;
      init();
      initAnim();
      ledEffect();
    }
  }
  
  function emojiGo(emj) {
    let value = document.getElementById("txt").value;
    value += emj;
    document.getElementById("txt").value = value;
  }
  
  function selOption() {

    var sel_gap = document.getElementById('Gap');
    for(var i = 0, j = sel_gap.options.length; i < j; ++i) {
        if (parseInt(sel_gap.options[i].value, 10)  === side) {
          sel_gap.selectedIndex = i;
          break;
        }
    }
    var sel_lsize = document.getElementById('Lsize');
    for(var i = 0, j = sel_lsize.options.length; i < j; ++i) {
        if (parseInt(sel_lsize.options[i].value, 10)  === dots) {
          sel_lsize.selectedIndex = i;
          break;
        }
    }
    
    selLegend();
    sliderSync();
    
  }

  function selLegend() {
  
    var sel_gap = document.getElementById('Gap');
    var sel_lsize = document.getElementById('Lsize');
    var gap = parseInt(sel_gap.options[sel_gap.options.selectedIndex].value, 10);
    var lsz = parseInt(sel_lsize.options[sel_lsize.options.selectedIndex].value, 10);
  
    generateLegend(gap, lsz);

  }

  function sliderSync() {
    var slider = document.getElementById('speed');
    slider.value = speed;
  }
  
  </script>
  
  <!DOCTYPE html>
  <html>
    <head>
      <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" charset="UTF-8"/>
      <!--meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8"-->
      <style>
        body {
          margin: 0px;
          height: 100%;
          background-color:black;
  
          /*cursor:none;*/
        }
        /*
        main {
          position: fixed;
          width: 100%;
          height: 100%;
        }
        */
        ::-webkit-scrollbar {
          display: none;
        }
        input[type=text] {
          width:60%;
          border:2px solid #aaa;
          border-radius: 4px;
          margin: 2% 2%;
          outline: none;
          padding: 8px;
          box-sizing: border-box;
        }
        input[type=text]:focus {
          border-color: dodgerblue;
          box-shadow: 0 0 8px 0 dodgerblue;
        }
        select {
          border:2px solid #aaa;
          border-radius: 4px;
          margin: 2% 2%;
          outline: none;
          padding: 8px;
          box-sizing: border-box;
        }
        .slider {
          -webkit-appearance: none;  /* Override default CSS styles */
          appearance: none;
          width: 100%; /* Full-width */
          height: 25px; /* Specified height */
          background: #d3d3d3; /* Grey background */
          outline: none; /* Remove outline */
          opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */
          -webkit-transition: .2s; /* 0.2 seconds transition on hover */
          transition: opacity .2s;
        }
          /*
        canvas {
              padding-left: 0;
              padding-right: 0;
              margin-left: 0;
              margin-right: 0;
              display: block;
        }
          */
          input[type=range]::-webkit-slider-runnable-track {
            width: 300px;
            height: 5px;
            background: #ddd;
            border: none;
            border-radius: 3px;
          }

          input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            border: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: goldenrod;
            margin-top: -4px;
          }

      </style>
      </head>   
  <body>
  
    <div id="ui" style="margin: 2% 2%;">
      <br/>
      <!--p style="font-size:48px">&#x1f604;</p-->
      <input type="text" id="txt" name="myfield" value="歡迎🐻" placeholder="message"/><br/>
      <input type="text" id="txt2" name="myfield" value="Hello🌏" placeholder="message"/><br/>
    
      <br/>

      <label for="favcolor" style="color:#ff0000;size: 48px;">Text color</label>
      <input type="color" id="favcolor" name="favcolor" value="#ffffff">

      <br/>

      <button type="button" id="go" style="margin: 2% 2%;width:120px;height:40px;border:2px #ff0000;" onclick="textGo()">OK</button>
      
      <br/>

    <a onclick="emojiGo('😀')">😀</a><a onclick="emojiGo('😆')">😆</a>
    <a onclick="emojiGo('😅')">😅</a><a onclick="emojiGo('😂')">😂</a>
    <a onclick="emojiGo('🤣')">🤣</a><a onclick="emojiGo('🥲')">🥲</a>
    <a onclick="emojiGo('😍')">😍</a><a onclick="emojiGo('😋')">😋</a> 
    <a onclick="emojiGo('😜')">😜</a><a onclick="emojiGo('😎')">😎</a> 
    <a onclick="emojiGo('😔')">😔</a><a onclick="emojiGo('😢')">😢</a> 
    <a onclick="emojiGo('😭')">😭</a><a onclick="emojiGo('😡')">😡</a>
    <a onclick="emojiGo('😳')">😳</a><a onclick="emojiGo('😱')">😱</a> 
    <a onclick="emojiGo('😨')">😨</a><a onclick="emojiGo('😵')">😵</a> 
    <a onclick="emojiGo('🤢')">🤢</a><a onclick="emojiGo('🤮')">🤮</a> 
    <a onclick="emojiGo('🤧')">🤧</a><a onclick="emojiGo('😷')">😷</a> 
    <a onclick="emojiGo('🤒')">🤒</a><a onclick="emojiGo('🤕')">🤕</a> 
    <a onclick="emojiGo('💩')">💩</a><a onclick="emojiGo('👻')">👻</a> 
    <a onclick="emojiGo('💀')">💀</a><a onclick="emojiGo('👽')">👽</a> 
    <a onclick="emojiGo('🤖')">🤖</a> 

    <br/>
  
    <label style="color:#ff0000;size: 48px;">Gap</label>
    <select name="Gap" id="Gap" onchange="selLegend()">
      <option value="0">0</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
    </select>
    <label style="color:#ff0000;size: 48px;">LED Size</label>
    <select name="Lsize" id="Lsize" onchange="selLegend()">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
    </select>

    <br/>

    <img id="legend" />
    
    <br/>

    <input type="range" min="20" max="400" step="20" value="120" id="speed" onchange=""/>
  
    </div>
  
    <canvas id="canvas" width="100" height="100" hidden="true"></canvas>
  
  </body>
  
  </html>
  
  
<script type="text/javascript" charset="UTF-8">


  var canvas;
  var ctx;
  
  function init() {
      canvas = document.getElementById("canvas");
      canvas.width  = window.outerWidth;
      canvas.height = window.outerHeight;
      ctx = canvas.getContext("2d");

      /*
      if (dots == 3) {
        initDot = ((side + 1) * canvas.width + (side + 1)) * 4;//(4 * fsize + 4) * 4;
      } else if (dots == 2) {
        initDot = ((side + 1) * canvas.width + (side + 1)) * 4;//(4 * fsize + 4) * 4;
      } else if (dots == 1) {
        initDot = (side * canvas.width + side) * 4;//(4 * fsize + 4) * 4;
      }
      */
      
      jumpLine = (side + dots) * canvas.width * 4;
      jumpSide = (side + dots) * 4;
      FONT = fsize + "px " + fontFamily;//黑體-繁";//宋體-繁";

      switch(dots) {
        case 1:
          initDot = (side * canvas.width + side) * 4;
          break;
        case 2:
        case 3:
        case 4:
          initDot = ((side + 1) * canvas.width + (side + 1)) * 4;
          break;
        case 5:
        case 6:
          initDot = ((side + 2) * canvas.width + (side + 2)) * 4;
          break;
        case 7:
          initDot = ((side + 3) * canvas.width + (side + 3)) * 4;
          break;
      }

      gapL = canvas.width * 4;
      gapP = 4;
      
      //fsize = Math.floor(fsize/(side + dots)) * (side + dots) + side;//102;

  }

  
  function newParticle_swingtxt(_txt, xx, yy) {
    let p = {
            x: xx,
            y: yy,
          txt: _txt,
         step: 0,
          len:0,
      release: function() {
        this.txt = '';
      },
      sinoutin: function(t) { // 0-1  15 * sinoutin(recoil_t * 1.0/8.0);
        return  Math.sin(t * Math.PI);//- (t-1) * (t-1) +1 ;
      },
      stepValue: function(peroidSec, range, dt) { //(float &_step, float peroidSec, float range, float dt) {
        this.step += dt/peroidSec;
        if (this.step > 1.0) {
          this.step = 0.0;
        }
        return this.sinoutin(this.step) * range;
      },
      initial: function (c) {
        this.step = 0;
        var _ctx = c.getContext("2d");
        _ctx.font = FONT;// + "px 標楷體";
        this.len = _ctx.measureText(this.txt).width;
        return this.len;
      },
  
      update: function (c, _ctx, dt) {
         
        if (dt > 1000) dt = 16;
        
        dt *= 0.001;

        this.x = this.stepValue(5.0, (c.width - this.len), dt);

        //this.x -= dt * 0.001 * speed;//dt * 0.001 * (dots + side) * 2;
  
        _ctx.textAlign = "left";
        _ctx.font = FONT;// + "px 標楷體";
        
        _ctx.strokeStyle = 'white';
        _ctx.lineWidth = 4;
          
        _ctx.fillStyle = 'white';

        _ctx.strokeText(this.txt, this.x, this.y);
        _ctx.fillText(this.txt, this.x, this.y);
  
      }
    }
    return p;
  }
  

  function newParticle_txt(_txt, xx, yy) {
    let p = {
            x: xx,
            y: yy,
          txt: _txt,
      release: function() {
        this.txt = '';
      },
      initial: function (c) {
        //this.release();
        //this.txt = subtitle[this.p][this.idx];
        var _ctx = c.getContext("2d");
        _ctx.font = FONT;// + "px 標楷體";
        return _ctx.measureText(this.txt).width;
      },
  
      update: function (c, _ctx, dt) {
         
        if (dt > 1000) dt = 16;
  
        this.x -= dt * 0.001 * speed;//dt * 0.001 * (dots + side) * 2;
         
        if (this.x < -_ctx.measureText(this.txt).width + 10) {
          this.x = c.width;
          return;
        }
          
        _ctx.textAlign = "left";
        _ctx.font = FONT;// + "px 標楷體";
        
        _ctx.strokeStyle = 'white';
        _ctx.lineWidth = 4;
          
        _ctx.fillStyle = 'white';

        _ctx.strokeText(this.txt, this.x, this.y);
        _ctx.fillText(this.txt, this.x, this.y);
  
      }
    }
    return p;
  }

  var _r = dot_r;// * Math.random();
  var _g = dot_g;// * Math.random();
  var _b = dot_b;// * Math.random();
  
  function anim_update(elapse) {
  
    //ctx.clearRect(0, 0, canvas.width, canvas.height);
  
    ctx.fillStyle = 'black';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  
    let dt = elapse - pre;
    pre = elapse;

    //ctx.fillStyle = 'white';
    //ctx.font = "16px Arial";
    //ctx.fillText(':'+dt, 32, 32);

    //if (Math.floor(Math.random() * 10) == 5) console.log(dt);
  
    if (keepGoing != 1) {
      if (phase != 0) {
        initAnim();
      }
      return;
    }

    for (var i = 0;i<particlesBG.length;i++) {
      particlesBG[i].update(canvas, ctx, dt);
    }

    for (var i = 0;i<particles.length;i++) {
        particles[i].update(canvas, ctx, dt);
        /*
        if (particles[i].activeFlag == false) {
          particles[i].initial(canvas);
          particles[i].x = canvas.width;
        }
        */
    }

    /*
    if (particles[particles.length - 1].activeFlag == false) { //
        let xx = canvas.width;
        for (var i = 0;i<particles.length;i++) {
          let txtlen = particles[i].initial(canvas);
          particles[i].x = xx;
          xx += txtlen + 2 * fsize;
        }
    }
    */
     
    if (!maskimg) {
      window.requestAnimationFrame(anim_update);
      return;
    }
  
    ctx.drawImage(maskimg, 0, 0);

    if (dots == 1) {
      window.requestAnimationFrame(anim_update);
      return;
    }

    let mask = ctx.getImageData(0, 0, canvas.width, canvas.height);
     var data = mask.data;

    //verticle
    //let gapL = fsize * 4;
    //verticle
    //let wid = fsize;
    
    let wid = canvas.width;
        
    for (let i = initDot;i < data.length;i += jumpLine) {
          
      //let pix = ;
      let h = Math.floor((i/4)/wid);
      //let w = pix%wi
      //if (h > maskHeight) break;

      for (let k = i;;k+=jumpSide) {

        let _pix = k/4;
        let _h = Math.floor(_pix/wid);
        let _w = _pix%wid;

        if (_w > maskWidth) break;
        if (_h != h) break;
        
        switch(dots) {
          case 2:
            setPix4_2(data, k);
            break;
          case 3:
            setPix4_3(data, k);
            break;
          case 4:
            setPix4_4(data, k);
            break;
          case 5:
            setPix4_5(data, k);
            break;
          case 6:
            setPix4_6(data, k);  
            break;
          case 7:
            setPix4_7(data, k);  
            break;
        }

      }
    }
      
    ctx.putImageData(mask, 0, 0);
    
    window.requestAnimationFrame(anim_update);
  
  }

  function setPix4_2(data, k) {
    if ((data[k] > criteria || data[k+1] > criteria || data[k+2] > criteria)) {
        _r = data[k];
        _g = data[k+1];
        _b = data[k+2];
    } else {
        _r = dot_none;
        _g = dot_none;
        _b = dot_none;
    }

    setPixColor(data, k,               _r, _g, _b);//中
    setPixColor(data, k - gapP,        _r, _g, _b);//左
    setPixColor(data, k - gapL,        _r, _g, _b);//上
    setPixColor(data, k - gapP - gapL, _r, _g, _b);//左上
  }

  function setPix4_3(data, k) {

    if ((data[k] > criteria || data[k+1] > criteria || data[k+2] > criteria)) {
        _r = data[k];
        _g = data[k+1];
        _b = data[k+2];
    } else {
        _r = dot_none;
        _g = dot_none;
        _b = dot_none;
    }

    setPixColor(data, k,               _r, _g, _b);//中
    setPixColor(data, k - gapP,        _r, _g, _b);//左
    setPixColor(data, k - gapL,        _r, _g, _b);//上
    setPixColor(data, k - gapP - gapL, _r/2, _g/2, _b/2);//左上

    //右
    setPixColor(data, k + gapP,        _r, _g, _b);
    //右上
    setPixColor(data, k + gapP - gapL, _r/2, _g/2, _b/2);
    //右下
    setPixColor(data, k + gapP + gapL, _r/2, _g/2, _b/2);
    //下
    setPixColor(data, k + gapL,        _r, _g, _b);
    //左下
    setPixColor(data, k - gapP + gapL, _r/2, _g/2, _b/2);

  }

  function setPix4_4(data, k) {   

    if ((data[k] > criteria || data[k+1] > criteria || data[k+2] > criteria)) {
        _r = data[k];
        _g = data[k+1];
        _b = data[k+2];
    } else if ((data[k + gapL + gapP] > criteria || data[k + gapL + gapP + 1] > criteria || data[k + gapL + gapP + 2] > criteria)) {
        _r = data[k + gapL + gapP];
        _g = data[k + gapL + gapP + 1];
        _b = data[k + gapL + gapP + 2];
    } else {
        
        _r = dot_none;
        _g = dot_none;
        _b = dot_none;
    }

    setPixColor(data, k,               _r, _g, _b);//中
    setPixColor(data, k - gapP,        _r, _g, _b);//左
    setPixColor(data, k - gapL,        _r, _g, _b);//上
    setPixColor(data, k - gapP - gapL, 0, 0, 0);//左上

    //右
    setPixColor(data, k + gapP,        _r, _g, _b);
    //右上
    setPixColor(data, k + gapP - gapL, _r, _g, _b);
    //右下
    setPixColor(data, k + gapP + gapL, _r, _g, _b);
    //下
    setPixColor(data, k + gapL,        _r, _g, _b);
    //左下
    setPixColor(data, k - gapP + gapL, _r, _g, _b);


    let _k = k + gapP + gapL + gapP + gapL;
    setPixColor(data, _k, 0, 0, 0);

    setPixColor(data, _k - gapL,               _r, _g, _b);
    setPixColor(data, _k - gapL - gapL,        _r, _g, _b);
    setPixColor(data, _k - gapL - gapL - gapL, 0, 0, 0);

    setPixColor(data, _k - gapP,               _r, _g, _b);
    setPixColor(data, _k - gapP - gapP,        _r, _g, _b);
    setPixColor(data, _k - gapP - gapP - gapP, 0, 0, 0);

  }

  function setPix4_5(data, k) {
    
    if ((data[k] > criteria || data[k+1] > criteria || data[k+2] > criteria)) {
        _r = data[k];
        _g = data[k+1];
        _b = data[k+2];
    } else if ((data[k + gapP] > criteria || data[k + gapP + 1] > criteria || data[k + gapP + 2] > criteria)) {
        _r = data[k + gapP];
        _g = data[k + gapP + 1];
        _b = data[k + gapP + 2];
    } else if ((data[k - gapP] > criteria || data[k - gapP + 1] > criteria || data[k - gapP + 2] > criteria)) {
        _r = data[k - gapP];
        _g = data[k - gapP + 1];
        _b = data[k - gapP + 2];
    } else if ((data[k - gapL] > criteria || data[k - gapL + 1] > criteria || data[k - gapL + 2] > criteria)) {
        _r = data[k - gapL];
        _g = data[k - gapL + 1];
        _b = data[k - gapL + 2];
    } else if ((data[k + gapL] > criteria || data[k + gapL + 1] > criteria || data[k + gapL + 2] > criteria)) {
        _r = data[k + gapL];
        _g = data[k + gapL + 1];
        _b = data[k + gapL + 2];
    } else {
        
        _r = dot_none;
        _g = dot_none;
        _b = dot_none;
    }
    
    let _k = k - 2 * gapP - 2 * gapL;
    for (let i = 0;i<5;i++) {
      for (let j = 0;j<5;j++) {
        setPixColor(data, _k + i * gapP + j * gapL, _r, _g, _b);
      }
    }

    setPixColor(data, _k, 0, 0, 0);
      
    setPixColor(data, _k + 4 * gapL, 0, 0, 0);
      
    setPixColor(data, _k + 4 * gapP, 0, 0, 0);
      
    setPixColor(data, _k + 4 * gapL + 4 * gapP, 0, 0, 0);
    
  }

  function setPix4_6(data, k) {
    
    if ((data[k] > criteria || data[k+1] > criteria || data[k+2] > criteria)) {
        _r = data[k];
        _g = data[k+1];
        _b = data[k+2];
    } else if ((data[k + gapP] > criteria || data[k + gapP + 1] > criteria || data[k + gapP + 2] > criteria)) {
        _r = data[k + gapP];
        _g = data[k + gapP + 1];
        _b = data[k + gapP + 2];
    } else if ((data[k + gapL] > criteria || data[k + gapL + 1] > criteria || data[k + gapL + 2] > criteria)) {
        _r = data[k + gapL];
        _g = data[k + gapL + 1];
        _b = data[k + gapL + 2];
    } else if ((data[k + gapL + gapP] > criteria || data[k + gapL + gapP + 1] > criteria || data[k + gapL + gapP + 2] > criteria)) {
        _r = data[k + gapL + gapP];
        _g = data[k + gapL + gapP + 1];
        _b = data[k + gapL + gapP + 2];
    } else {
        _r = dot_none;
        _g = dot_none;
        _b = dot_none;
    }

    let _k = k - 2 * gapP - 2 * gapL;
    for (let i = 0;i<6;i++) {
      for (let j = 0;j<6;j++) {
        setPixColor(data, _k + i * gapP + j * gapL, _r, _g, _b);
      }
    }

    setPixColor(data, _k, 0, 0, 0);
    
    setPixColor(data, _k + 5 * gapL, 0, 0, 0);
    
    setPixColor(data, _k + 5 * gapP, 0, 0, 0);
    
    setPixColor(data, _k + 5 * gapL + 5 * gapP, 0, 0, 0);
  
  }

  function setPix4_7(data, k) {
    
    if ((data[k] > criteria || data[k+1] > criteria || data[k+2] > criteria)) {
        _r = data[k];
        _g = data[k+1];
        _b = data[k+2];
    } else if ((data[k + gapP] > criteria || data[k + gapP + 1] > criteria || data[k + gapP + 2] > criteria)) {
        _r = data[k + gapP];
        _g = data[k + gapP + 1];
        _b = data[k + gapP + 2];
    } else if ((data[k - gapP] > criteria || data[k - gapP + 1] > criteria || data[k - gapP + 2] > criteria)) {
        _r = data[k - gapP];
        _g = data[k - gapP + 1];
        _b = data[k - gapP + 2];
    } else if ((data[k - gapL] > criteria || data[k - gapL + 1] > criteria || data[k - gapL + 2] > criteria)) {
        _r = data[k - gapL];
        _g = data[k - gapL + 1];
        _b = data[k - gapL + 2];
    } else if ((data[k + gapL] > criteria || data[k + gapL + 1] > criteria || data[k + gapL + 2] > criteria)) {
        _r = data[k + gapL];
        _g = data[k + gapL + 1];
        _b = data[k + gapL + 2];
    } else {
        
        _r = dot_none;
        _g = dot_none;
        _b = dot_none;
    }

    let _k = k - 3 * gapP - 3 * gapL;
    for (let i = 0;i<7;i++) {
      for (let j = 0;j<7;j++) {
        setPixColor(data, _k + i * gapP + j * gapL, _r, _g, _b);
      }
    }

    setPixColor(data, _k, 0, 0, 0);
      setPixColor(data, _k + gapL, _r/2, _g/2, _b/2);
      setPixColor(data, _k + gapP, _r/2, _g/2, _b/2);

    setPixColor(data, _k + 6 * gapL, 0, 0, 0);
      setPixColor(data, _k + 5 * gapL, _r/2, _g/2, _b/2);
      setPixColor(data, _k + 6 * gapL + gapP, _r/2, _g/2, _b/2);

    setPixColor(data, _k + 6 * gapP, 0, 0, 0);
      setPixColor(data, _k + 5 * gapP, _r/2, _g/2, _b/2);
      setPixColor(data, _k + 6 * gapP + gapL, _r/2, _g/2, _b/2);

    setPixColor(data, _k + 6 * gapL + 6 * gapP, 0, 0, 0);
      setPixColor(data, _k + 5 * gapL + 6 * gapP, _r/2, _g/2, _b/2);
      setPixColor(data, _k + 6 * gapL + 5 * gapP, _r/2, _g/2, _b/2);
  }

  function setPixColor(data, idx, r, g, b) {
    data[idx]     = r;
    data[idx + 1] = g;
    data[idx + 2] = b;
    data[idx + 3] = 255;
  }
  
  function initAnim() {
  
    keepGoing = 0;

    //if (phase == 0) return;
    if (subtitle.length == 1) return;

    var c = document.getElementById("canvas");
    var ctx = c.getContext("2d");
  
    //console.log(c.width + ', ' + c.height);
    
    if (particles.length >= 1) {
      for (var i = 0;i<particles.length;i++) {
        particles[i].release();
      }
    }

    particles.length = 0;
    particles = [];
  
    /*
    //verticle
    let xx = fsize;
    let yy = c.height + fsize;
    let _idx = 0;
    var total = subtitle[phase].length;//Math.min(35, 15 + 5 * Math.floor(c.width/500));//console.log('total:'+total);
    for (_idx = 0;_idx<total;_idx++) {
        particles[_idx] = newParticle_txt(phase, _idx,  xx, yy);//();
        let txtlen = particles[_idx].initial(c);
        yy += (txtlen + 2) * fsize;
    }
    */

    //for (let _i = 1;_i<subtitle.length;_i++) {}

    //let yy = c.height/4.0 + fsize/2;
    
    fsize = canvas.height/3;
    FONT = fsize + "px " + fontFamily;
    let xx = c.width;

    //var total = subtitle[1].length;//Math.min(35, 15 + 5 * Math.floor(c.width/500));//console.log('total:'+total);
    if (subtitle[2][0].length > 0) {
      particles[0] = newParticle_txt(subtitle[1][0], xx, 0.5 * c.height - fsize/10);//();
      particles[0].initial(c);
      particles[1] = newParticle_txt(subtitle[2][0], xx, 0.5 * c.height + fsize + fsize/10);//();
      particles[1].initial(c);
    } else {
      fsize = canvas.height/2;
      FONT = fsize + "px " + fontFamily;
      particles[0] = newParticle_txt(subtitle[1][0], xx, 0.5 * c.height + fsize/3);//();
      particles[0].initial(c);
    }
    
    if (particlesBG.length >= 1) {
      for (var i = 0;i<particlesBG.length;i++) {
        particlesBG[i].release();
      }
    }

    particlesBG.length = 0;
    particlesBG = [];

    /*
    for (var i = 0;i<150;i++) {
      if (Math.random() > 0.5)  
        particlesBG[i] = newParticle_in();
      else 
        particlesBG[i] = newParticle_out();
      particlesBG[i].initial(canvas);
    }
     */
    
    /*
    for (var i = 0;i<150;i++) {
      particlesBG[i] = newParticle_casual();
      particlesBG[i].initial(canvas);
    }
    */
    /*
    for (var i = 0;i<150;i++) {
      particlesBG[i] = newParticle_in();
      particlesBG[i].initial(canvas);
    }
    */
    /*
    for (var i = 0;i<150;i++) {
      particlesBG[i] = newParticle_out();
      particlesBG[i].initial(canvas);
    }
    */
    /*
    for (var i = 0;i<150;i++) {
      particlesBG[i] = newParticle_ring();
      particlesBG[i].initial(canvas);
    }
    */
    /*
    for (var i = 0;i<150;i++) {
      particlesBG[i] = newParticle_snow();
      particlesBG[i].initial(canvas);
    }
    */
    
    /*
    for (var i = 0;i<3;i++) {
      particlesBG[i] = newParticle_firework();
      particlesBG[i].initial(canvas);
    }
    */
    /*
    for (var i = 0;i<20;i++) {
      particles[i] = newParticle_rect();
      particles[i].initial(canvas);
    }
    */
    /*
    particlesBG[0] = newClock();
    particlesBG[0].initial(canvas);
    */

    keepGoing = 1;
    window.requestAnimationFrame(anim_update);
  
  }

  function generateLegend(s, d) {
  
    let w = 160;
    let h = 100;

    let _maskWidth = (Math.floor(w/(s + d))) * (s + d);
    let _maskHeight = (Math.floor(h/(s + d))) * (s + d);
     
    var mask = ctx.createImageData(w, h);
    var data = mask.data;
  
    for (let y = 0; y < h; y++) {
      for (let x = 0; x < w; x++) {
  
          let idx = (y * w + x) * 4;
  
          data[idx + 0] = 0;//40;
          data[idx + 1] = 0;//40;
          data[idx + 2] = 0;//40;
          data[idx + 3] = 255;
          
          let _x = x%(s + d);
          let _y = y%(s + d);

          if (_x >= s && _y >= s && x < _maskWidth && y < _maskHeight) { //d

            let c = s + Math.floor(d/2.0);
            if (d%2 == 0) {
              c = s + d/2.0 - 0.5;
            }

            let len = Math.sqrt((_x - c)*(_x - c) +(_y - c)*(_y - c));
            let r = Math.floor(d/2.0);

            data[idx + 0] = dot_none * 2;//40;
            data[idx + 1] = dot_none * 2;//40;
            data[idx + 2] = dot_none * 2;//40;

            switch(d) {
              case 3:
              case 4:
              case 5:
                if (len <= r) {
                  data[idx + 3] = 255;
                } else {
                  data[idx + 3] = 128;//255 * (1- 2 * Math.abs(len - r)/r);
                }
                break;
              case 6:
                if (len <= r * 0.9) {
                  data[idx + 3] = 255;
                } else {
                  data[idx + 3] = 255 * (1- 5 * Math.abs(len - r)/r);
                }
                break;
              case 7:
               if (len <= r) {
                  data[idx + 3] = 255;
                } else {
                  data[idx + 3] = 255 * (1- 2 * Math.abs(len - r)/r);
                }
                break;
                break;
            }

            
            /*
            if (d == 3) {
              
            } else if (d == 4 || d == 5 || d == 6) {
              
            } else if (d == 7) {
              
            }
            */
          }
      }
    }
    ///////


    // create a temporary canvas
    var tempCanvas = document.createElement("canvas");
    var tempCtx = tempCanvas.getContext("2d");
  
    // set the temp canvas size == the canvas size
    tempCanvas.width = w;
    tempCanvas.height = h;
  
    // put the modified pixels on the temp canvas
    tempCtx.putImageData(mask, 0, 0);
  
    var img = document.getElementById('legend');

    //console.log(tempCanvas.toDataURL());

    img.src = tempCanvas.toDataURL();

  }
  
  function generateMask(w, h, s, d) {
  
    var mask = ctx.createImageData(w, h);
    var data = mask.data;
  
    for (let y = 0; y < h; y++) {
      for (let x = 0; x < w; x++) {
  
          let idx = (y * w + x) * 4;
  
          data[idx + 0] = 0;//40;
          data[idx + 1] = 0;//40;
          data[idx + 2] = 0;//40;
          data[idx + 3] = 255;
          
          let _x = x%(s + d);
          let _y = y%(s + d);
          if (_x >= s && _y >= s && x < maskWidth && y < maskHeight) { //d
            data[idx + 3] = 0;
          }
  
      }
    }
  
    return mask;
  
  }
  
  var maskimg;
  
  function ledEffect() {
    
    //verticle
    //let w = fsize;
    //let h = canvas.height;
  
    let w = canvas.width;//maskWidth
    let h = canvas.height;//maskHeight

    maskWidth = (Math.floor(w/(side + dots))) * (side + dots);
    maskHeight = (Math.floor(h/(side + dots))) * (side + dots);
  
    var mask = generateMask(w, h, side, dots);
          
    // create a temporary canvas
    var tempCanvas = document.createElement("canvas");
    var tempCtx = tempCanvas.getContext("2d");
  
    // set the temp canvas size == the canvas size
    tempCanvas.width = w;
    tempCanvas.height = h;
  
    // put the modified pixels on the temp canvas
    tempCtx.putImageData(mask, 0, 0);
  
    // use the tempCanvas.toDataURL to create an img object
    maskimg = new Image();
    //maskimg.onload = function() {}
    maskimg.src = tempCanvas.toDataURL();
  
  }
  
  var phase = 0;
  var keepGoing = 1;
  
  var pre = 0;
  var particles = [];
  var particlesBG = [];
  var doblank = 0;

  function ledSwitch() {
    if (maskimg != null) {
        maskimg = null;
    } else {
        ledEffect();
    }
  }
  
  function keyboard(e) {
  
      if (canvas.hidden) return; 
  
      switch (e.keyCode) {
          case 76: //'l'
              ledSwitch();
              break;
          case 66: //'b'
              doblank = doblank == 0?1:0;
              break;
          case 38: //'ArrowUp'
              speed += 20;
              break; 
          case 40: //'ArrowDown':
              speed -= 20;
              //if (speed < 10) speed = 0;
              break;
          case 37: //'ArrowLeft'
              break; 
          case 39: //'ArrowRight'
              break;
          case 48:    case 49:  case 50:  case 51:  case 52:  case 53:  case 54:  case 55:  case 56:  case 57: {
          //case '0': case '1': case '2': case '3': case '4': case '5': case '6': case '7': case '8': case '9':
              var value = e.keyCode - 48;
              if (value > subtitle.length - 1)
                  break;
              
              phase = value;
              if (keepGoing == 0) {
                initAnim();
              } else {
                keepGoing = 0;
              }
  
          }
          break;
          case 73: //i
            //inputTxt();
            if (canvas.hidden == false) {
              switch2Input();
            } else {
              switch2Marquee();
            }
            break;
          case 32: canvas.requestFullscreen(); break;

              
      }
  
  }
  
  
  function switch2Input() {
    selOption();
    sliderSync();
    keepGoing = 0;
    var div = document.getElementById('ui');
    if (div) {
      div.hidden = false;
      canvas.hidden = true;
    }
    
  }
  
  function switch2Marquee() {
    var div = document.getElementById('ui');
    if (div) {
      div.hidden = true;
      canvas.hidden = false;
    }
  }


  function getTouchPos(canvasDom, touchEvent) {
    var rect = canvasDom.getBoundingClientRect();
    return { x: touchEvent.touches[0].clientX - rect.left,
             y: touchEvent.touches[0].clientY - rect.top};
  }

  init();
  switch2Input();

  window.addEventListener('keyup', keyboard, false);
  window.addEventListener('resize', function() {
    init(); //initAnim();
    if (maskimg != null) {
      ledEffect();
    }
  });

  document.getElementsByTagName("canvas")[0].addEventListener("touchstart", function(evt) {
          //canvas.requestFullscreen();

          if (canvas.hidden) return;

          evt.preventDefault();
          var touches = getTouchPos(canvas, evt);

          if (touches.x > canvas.width/2 && touches.y > canvas.height/2) { //右下
              switch2Input();
              return;
          }
          if (touches.x < canvas.width/2 && touches.y > canvas.height/2) { //左下

          }
          if (touches.x > canvas.width/2 && touches.y < canvas.height/2) { //右上
              ledSwitch();
          }
          if (touches.x < canvas.width/2 && touches.y < canvas.height/2) { //左上

          }

        });

</script>

  
<script type="text/javascript" charset="UTF-8">

  function newParticle_casual() {
    let p = {
      x: 0,
      y: 0,
      v:100,
      R: 0,
      G: 0,
      B: 0,
      A: 0,
      radius:10,
      dir:0,
      release: function() { },
      initial: function (c) {
        
        let short = Math.min(c.width, c.height);
        let range = short * 0.4 + (Math.random() * short * 0.1) * (Math.random() >0.5?1:-1);
        let angle = Math.random() * 360 * Math.PI/180;
        this.x = c.width/2 + range * Math.cos(angle);
        this.y = c.height/2 + range * Math.sin(angle);
        this.v = 30 + Math.random() * 30; 
        this.R = 100 + 155 * Math.random();
        this.G = 100 + 155 * Math.random();
        this.B = 100 + 155 * Math.random();
        this.A = Math.random();//0.5 + Math.random()/2.0;
        this.radius = 10 + Math.random() * 10;
        this.dir = Math.random() * 360 * Math.PI/180;
  
      },
      update: function (c, _ctx, dt) {
  
        this.x = this.x + this.v * dt * 0.001 * Math.cos(this.dir);
        this.y = this.y + this.v * dt * 0.001 * Math.sin(this.dir);
        //ctx.save();
        _ctx.fillStyle = 'rgb(' + this.R + ',' + this.G + ',' + this.B + ',' + this.A + ')'; //"rgb(0,0,200)";
        //ctx.fillRect (this.x - this.radius/2.0, this.y - this.radius/2.0, this.radius, this.radius);
        _ctx.beginPath();
        _ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI, true);
        _ctx.fill();
        
        //ctx.restore();
        
        this.A = this.A - 0.3 * dt * 0.001;
        if (this.A < 0.01) {
          this.initial(c);
          this.A = 0.5 + Math.random()/2.0;
          //this.A = 0.5 + Math.random()/2.0;
        }
        //console.log(this.y + ', ' + this.x + ':' + dt);
      }
    }
    return p;
  }
  
  function newParticle_in() {
    let p = {
      x_stt: 0,
      y_stt: 0,
      x_end: 0,
      y_end: 0,
      R: 0,
      G: 0,
      B: 0,
      A: 0,
      radius:10,
      t:0,
      elapse:0,
      release: function() { },
      easein:function(_t) {
        return _t * _t * _t;
      },
      easeout:function(_t) {
        return -_t * _t + 2 * _t;
      },
      initial: function (c) {
        
        let short = Math.min(c.width, c.height);
        let long = Math.max(c.width, c.height) * 0.5;
        let range = Math.random() * short * 0.1;
        let dir = Math.random() * 360 * Math.PI/180;
        
        this.x_stt = c.width/2 + range * Math.cos(dir);
        this.y_stt = c.height/2 + range * Math.sin(dir);
        
        this.x_end = c.width/2 + long * Math.cos(dir);
        this.y_end = c.height/2 + long * Math.sin(dir);
        
        this.R = 100 + 155 * Math.random();
        this.G = 100 + 155 * Math.random();
        this.B = 100 + 155 * Math.random();
        this.A = 1.0;//0.5 + Math.random()/2.0;
  
        this.radius = 20 + Math.random() * 50;
        this.elapse = 1.0 + 4.0 * (70 - this.radius) /70;
        this.t = 0;
  
      },
      update: function (c, _ctx, dt) {
  
        this.t += dt/1000.0;
        let ein = this.easein(this.t/this.elapse);
        let x = this.x_stt + (this.x_end - this.x_stt) * ein;
        let y = this.y_stt + (this.y_end - this.y_stt) * ein;
        this.A = 1.0 + (0-1.0) * ein;
        let r = 0.0 + (this.radius - 0) * ein;
        if (r < 0)
          r = this.radius;
        //ctx.save();
        _ctx.fillStyle = 'rgb(' + this.R + ',' + this.G + ',' + this.B + ',' + this.A + ')';//"rgb(0,0,200)";
        //ctx.fillRect (this.x - this.radius/2.0, this.y - this.radius/2.0, this.radius, this.radius);
        _ctx.beginPath();
        _ctx.arc(x, y, r, 0, 2 * Math.PI, true);
        _ctx.fill();
        if (this.t > this.elapse) {
          this.initial(c);
        }
      }
    }
    return p;
  }
  
  function newParticle_out() {
    let p = {
      x_stt: 0,
      y_stt: 0,
      x_end: 0,
      y_end: 0,
      R: 0,
      G: 0,
      B: 0,
      A: 0,
      radius:10,
      t:0,
      elapse:0,
      release: function() { },
      easein:function(_t) {
        return _t * _t * _t;
      },
      easeout:function(_t) {
        return -_t * _t + 2 * _t;
      },
      initial: function (c) {
        
        let short = Math.min(c.width, c.height);
        let long = Math.max(c.width, c.height) * 0.5;
        let range = (Math.random() * short * 0.1);
        let dir = Math.random() * 360 * Math.PI/180;
        
        this.x_end = c.width/2 + range * Math.cos(dir);
        this.y_end = c.height/2 + range * Math.sin(dir);
        
        this.x_stt = c.width/2;// + long * Math.cos(dir);
        this.y_stt = c.height/2;// + long * Math.sin(dir);
        
        this.R = 100 + 155 * Math.random();
        this.G = 100 + 155 * Math.random();
        this.B = 100 + 155 * Math.random();
        this.A = 1.0;//0.5 + Math.random()/2.0;
  
        this.radius = 20 + Math.random() * 50;
        this.elapse = 1.0 + 4.0 * (70 - this.radius) /70;
        this.t = 0;
  
      },
      update: function (c, _ctx, dt) {
  
        this.t += dt/1000.0;
        let ein = this.easeout(this.t/this.elapse);
        let x = this.x_stt + (this.x_end - this.x_stt) * ein;
        let y = this.y_stt + (this.y_end - this.y_stt) * ein;
        this.A = 0 + (1.0 - 0) * ein;
        let r = this.radius + (0 - this.radius) * ein;
        if (r < 0)
          r = this.radius;
        //ctx.save();
        _ctx.fillStyle = 'rgb(' + this.R + ',' + this.G + ',' + this.B + ',' + this.A + ')';//"rgb(0,0,200)";
        //ctx.fillRect (this.x - this.radius/2.0, this.y - this.radius/2.0, this.radius, this.radius);
        _ctx.beginPath();
        _ctx.arc(x, y, r, 0, 2 * Math.PI, true);
        _ctx.fill();
        if (this.t > this.elapse) {
          this.initial(c);
        }
      }
    }
    return p;
  }
  
  function newParticle_ring() {
    let p = {
      type:  0,
      x_stt: 0,
      y_stt: 0,
      x_end: 0,
      y_end: 0,
      R: 0,
      G: 0,
      B: 0,
      A: 0,
      radius:10,
      t:0,
      elapse:0,
      release: function() { },
      easein:function(_t) {
        return _t * _t * _t;
      },
      easeout:function(_t) {
        return -_t * _t + 2 * _t;
      },
      initial: function (c) {
        
        let short = Math.min(c.width, c.height);
        let long = Math.max(c.width, c.height) * 0.5;
        let range = (Math.random() * short * 0.1);
        let dir = Math.random() * 360 * Math.PI/180;
        
        if (this.type == 0) {
          this.x_stt = c.width/2 + (short * 0.05 + range) * Math.cos(dir);
          this.y_stt = c.height/2 + (short * 0.05 + range) * Math.sin(dir);
        
          this.x_end = c.width/2 + long * Math.cos(dir);
          this.y_end = c.height/2 + long * Math.sin(dir);  
          
        } else {
  
          this.x_end = c.width/2 + (short * 0.05 + range) * Math.cos(dir);
          this.y_end = c.height/2 + (short * 0.05 + range) * Math.sin(dir);
        
          this.x_stt = c.width/2 + long * Math.cos(dir);
          this.y_stt = c.height/2 + long * Math.sin(dir);
        }
        
        this.R = 100 + 155 * Math.random();
        this.G = 100 + 155 * Math.random();
        this.B = 100 + 155 * Math.random();
        this.A = 1.0;//0.5 + Math.random()/2.0;
  
        this.radius = 20 + Math.random() * 50;
        this.elapse = 1.0;//1.0 + 4.0 * (70 - this.radius) /70;
        this.t = 0;
  
      },
      update: function (c, _ctx, dt) {
  
        this.t += dt/1000.0;
        let ein = this.type == 0?this.easein(this.t/this.elapse):this.easeout(this.t/this.elapse);
        let x = this.x_stt + (this.x_end - this.x_stt) * ein;
        let y = this.y_stt + (this.y_end - this.y_stt) * ein;
        if (this.type == 0)
          this.A = 1.0 + (0-1.0) * ein;
        else 
          this.A = 0.0 + (1.0 - 0) * ein;
        let r = 0.0 + (this.radius - 0) * ein;
        if (this.type == 1)
          r = this.radius + (0 - this.radius) * ein;
        if (r < 0) r = 0;
        //ctx.save();
        _ctx.fillStyle = 'rgb(' + this.R + ',' + this.G + ',' + this.B + ',' + this.A + ')';//"rgb(0,0,200)";
        //ctx.fillRect (this.x - this.radius/2.0, this.y - this.radius/2.0, this.radius, this.radius);
        _ctx.beginPath();
        _ctx.arc(x, y, r, 0, 2 * Math.PI, true);
        _ctx.fill();
        
        if (this.t > this.elapse) {
          this.type = this.type == 0?1:0;
          this.initial(c);
        }
  
      }
    }
    return p;
  }
  
  function newParticle_firework_particle() {
    let p = {
      x_stt: 0,
      y_stt: 0,
      x_end: 0,
      y_end: 0,
      R: 0,
      G: 0,
      B: 0,
      A: 0,
      radius:10,
      t:0,
      elapse:0,
      easein:function(_t) {
        return _t * _t * _t;
      },
      easeout:function(_t) {
        return -_t * _t + 2 * _t;
      },
      easeinout:function(_t) {
        //console.log('sin('+ _t * Math.PI+(') = '+Math.sin(_t * Math.PI)));
        return Math.sin(_t * Math.PI);
      },
      release: function() { },
      colorDis: function(idx) {
        let r0 = 155 * Math.random();
        let r1 = 155 * Math.random();
        let rc0 = 200 + 55 * Math.random();
        let rc1 = 200 + 55 * Math.random();
        switch(idx) {
          case 0: this.R = rc0; this.G =  r0; this.B =  r1;  break;
          case 1: this.R =  r0; this.G = rc0; this.B =  r1;  break;
          case 2: this.R =  r0; this.G =  r1; this.B = rc0;  break;
          case 3: this.R =  r0; this.G = rc0; this.B = rc1;  break;
          case 4: this.R = rc0; this.G =  r0; this.B = rc1;  break;
          case 5: this.R = rc0; this.G = rc1; this.B =  r0;  break;
        }
      },
      initial: function (c, _x, _y, _range, _elapse, idx) {
        
        let r0 = Math.random();
        while (Math.random() > r0/2.0) r0 = Math.random();
        let range = r0 * _range;
  
        let dir = Math.random() * 360 * Math.PI/180;
        
        this.x_stt = _x;// + (short * 0.05 + range) * Math.cos(dir);
        this.y_stt = _y;//c.height/2;// + (short * 0.05 + range) * Math.sin(dir);
        
        this.x_end = this.x_stt + range * Math.cos(dir);
        this.y_end = this.y_stt + range * Math.sin(dir);
        
        this.colorDis(idx);
        
        this.A = 1.0;//0.5 + Math.random()/2.0;
        
        this.radius = 6 + 4 * (1- range/_range);// + Math.random() * 50;
        this.elapse = _elapse;
        this.t = 0;
  
      },
      update: function (c, _ctx, dt) {
  
        this.t += dt/1000.0;
        let eout = this.easeout(this.t/this.elapse);
        let x = this.x_stt + (this.x_end - this.x_stt) * eout;
        let y = this.y_stt + (this.y_end - this.y_stt) * eout;
        //console.log('t:' + this.t/this.elapse);
        this.A = this.easeinout(this.t/this.elapse);
        let r = 0.0 + (this.radius - 0) * eout;
        if (r < 0) r = 0;
        //ctx.save();
        _ctx.fillStyle = 'rgb(' + this.R + ',' + this.G + ',' + this.B + ',' + this.A + ')';//"rgb(0,0,200)";
        //ctx.fillRect (this.x - this.radius/2.0, this.y - this.radius/2.0, this.radius, this.radius);
        _ctx.beginPath();
        _ctx.arc(x, y, r, 0, 2 * Math.PI, true);
        _ctx.fill();
        
        if (this.t > this.elapse) {
          this.t = this.elapse;
        }
      }
    }
    return p;
  }
  
  function newParticle_firework() {
    let p = {
      particles:[],
      
      t:0,
      elapse:0,
      initial: function (c) {
        
        let x = c.width * (0.2 + Math.random() * 0.6);// + (short * 0.05 + range) * Math.cos(dir);
        let y = c.height * (0.2 + Math.random() * 0.6);
        let range = c.width * 0.2 * (0.5 + Math.random()/2.0);
  
        this.elapse = 0.7 + Math.random()/2.0;//1.0 + 4.0 * (70 - this.radius) /70;
        this.t = 0;
  
        if (this.particles.length < 1) {
          for (var i = 0;i<80;i++) {
            this.particles[i] = newParticle_firework_particle();
          }
        }
  
        let idx = Math.floor(Math.random() * 6);
        
        for (var i = 0;i<this.particles.length;i++) {
          this.particles[i].initial(c, x, y, range, this.elapse, idx);
        }
  
      },
      release: function() {
        this.particles.length = 0;
        this.particles = [];
      },
      update: function (c, _ctx, dt) {
  
        this.t += dt/1000.0;
  
        for (var i = 0;i<this.particles.length;i++) {
          this.particles[i].update(c, _ctx, dt);
        }
  
        if (this.t > this.elapse) {
          this.initial(c);
        }
      }
    }
    return p;
  }
  
  function newParticle_rect() {
    let p = {
      x: 0,
      y: 0,
      v: 0,
      R: 0,
      G: 0,
      B: 0,
      A: 0,
      radius:10,
      release: function() { },
      initial: function (c) {
                    
        this.x = c.width * (0.2 + Math.random() * 0.6);
        this.y = c.height * (0.5 + Math.random() * 0.5);
        this.v = 0.2 + Math.random() * 0.5; 
        this.R = 155 * Math.random();
        this.G = 155 * Math.random();
        this.B = 155 * Math.random();
        this.A = 0.5 + Math.random() * 0.2;
        this.radius = 150 + Math.random() * 150;
  
      },
      update: function (c, _ctx, dt) {
        
        _ctx.fillStyle = 'rgb(' + this.R + ',' + this.G + ',' + this.B + ',' + this.A + ')'; //"rgb(0,0,200)";
        _ctx.fillRect (this.x - this.radius * 0.7, this.y - this.radius/2.0, this.radius * 1.4, this.radius);
        
        
        this.A = this.A - this.v * dt * 0.001;
        if (this.A < 0.01) {
          this.initial(c);
        }
        //console.log(this.y + ', ' + this.x + ':' + dt);
      }
    }
    return p;
  }
  
  function newClock() {
    let p = {
      release: function() { },
      initial: function (c) { },
      update: function (c, _ctx, dt) {
        
        var x = c.width/2.0;
        var y = c.height/2.0;
        var len = c.height/5.0;
  
        var date = new Date();
  
        //var n = d.getTime();
        //_ctx.font = "64px Arial";
        //_ctx.fillStyle = 'rgb(' + this.R + ',' + this.G + ',' + this.B + ',' + this.A + ')'; //"rgb(0,0,20)"
        //if (Math.random() > 0.5) _ctx.fillText(h + ':' + min +':' + s, this.x, this.y);
  
        let h = date.getHours() % 12;
        let min = date.getMinutes();
        let s = date.getSeconds();
        let ms = date.getMilliseconds();
  
        _ctx.strokeStyle = "rgb(100, 100, 100)";
        _ctx.lineWidth = 16;
        _ctx.beginPath();
        _ctx.arc(x, y, 2 * len + 10, 0, 2 * Math.PI, true);
        _ctx.stroke();
  
        _ctx.fillStyle = "rgb(100, 100, 100)";
        for (let i = 0;i<12;i++) {
          let angle = (90 - i * 360.0/12.0) * Math.PI/180;
          let dx = 2 * len * Math.cos(angle);
          let dy = -2 * len * Math.sin(angle);
          _ctx.beginPath();
          _ctx.arc(x + dx, y + dy, len/5, 0, 2 * Math.PI, true);
          _ctx.fill();
        }
  
        _ctx.lineCap = "round";
  
        /*
         * HOUR
         */
        let angle = (90 - (h + min/60.0) * 360.0/12.0) * Math.PI/180;
        let dx = 0.8 * len * Math.cos(angle);
        let dy = -0.8 * len * Math.sin(angle);
        
        _ctx.beginPath();
        _ctx.moveTo(x, y);
        _ctx.lineTo(x + dx, y + dy);
        _ctx.lineWidth = 40;
        _ctx.strokeStyle = "rgb(0, 0, 150)";
        _ctx.stroke();
        
        /*
         * MINUTE
         */
        angle = (90 - (min + s/60.0) * 360.0/60.0) * Math.PI/180;
        dx = 1.5 * len * Math.cos(angle);
        dy = -1.5 * len * Math.sin(angle);
  
        _ctx.beginPath();
        _ctx.moveTo(x, y);
        _ctx.lineTo(x + dx, y + dy);
        _ctx.lineWidth = 20;
        _ctx.strokeStyle =  "rgb(120, 120, 0)";
        _ctx.stroke();
        
        /*
         * SECOND
         */
        //var gap = Math.floor(ms/(1000/10));
        //console.log(gap);
        //angle = (90 - (s + gap/10) * 360.0/60.0) * Math.PI/180;
        angle = (90 - (s + ms/1000.0) * 360.0/60.0) * Math.PI/180;
        dx = 1.7 * len * Math.cos(angle);
        dy = -1.7 * len * Math.sin(angle);
  
        _ctx.beginPath();
        _ctx.moveTo(x, y);
        _ctx.lineTo(x + dx, y + dy);
        _ctx.lineWidth = 10;
        _ctx.strokeStyle = "rgb(120, 0, 0)";
        _ctx.stroke();
  
        
        _ctx.beginPath();
        _ctx.fillStyle = "rgb(120, 0, 0)";
        _ctx.arc(x, y, 20, 0, 2 * Math.PI, true);
        _ctx.fill();
        
      }
    }
    return p;
  }
  
  function newParticle_snow() {
    let p = {
      x: 0,
      y: 0,
      v: 100,
      R: 0,
      G: 0,
      B: 0,
      A: 0,
      radius:10,
      release: function() { },
      initial: function (c) {
        
        let short = Math.min(c.width, c.height);
        let range = short * 0.4 + (Math.random() * short * 0.1) * (Math.random() >0.5?1:-1);
        let angle = Math.random() * 360 * Math.PI/180;
        this.x = c.width * (0.1 + Math.random() * 0.8);// + range * Math.cos(angle);
        this.y = -Math.random() * c.height * 0.2;
        let gray = 100 + 100 * Math.random();
        this.R = gray;
        this.G = gray;
        this.B = gray;
        this.A = 0.4 + Math.random() * 0.6;//0.3 - 1.0 
        this.radius = 0.02 * c.width * ((1 - this.A) + 0.1); //0.7 - 0
        this.v = 20 * this.radius;
  
      },
      update: function (c, _ctx, dt) {
  
        this.x = this.x + (-0.15 + Math.random() * 0.3) * dt;
        this.y = this.y + 0.001 * this.v * dt;
        //ctx.save();
        _ctx.fillStyle = 'rgb(' + this.R + ',' + this.G + ',' + this.B + ',' + this.A + ')'; //"rgb(0,0,200)";
        //ctx.fillRect (this.x - this.radius/2.0, this.y - this.radius/2.0, this.radius, this.radius);
        _ctx.beginPath();
        _ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI, true);
        _ctx.fill();
        
  
        //ctx.restore();
        this.A = this.A - dt * 0.0002;
  
        if (this.A < 0.01) {
          this.initial(c);
        }
      }
    }
    return p;
  }
  
</script>
