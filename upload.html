<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>‰∏äÂÇ≥Ë¶ÅÁî®ÁöÑÊ™îÊ°à</title>
    <link rel="stylesheet" href="ui_green.css" />
    <style>
        .wrapper {
            display: grid;
            gap: 0px;

            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;

            width: 100%;
            height: 100vh;
        }

        #drop-zone {
            width: 80%;
            height: 80%;
            border: 2px dashed #ffffff;
            border-radius: 10px;
            text-align: center;
            line-height: 30px;
            color: #ffffff;
            font-family: sans-serif;
            margin: 10px auto;
        }

        .topleft {
            grid-column: 1 / 30;
            grid-row: 1 / 12;
            background-color: #008000;
            text-align: center;
            line-height: 20vh;
            color: white;
            font-size: 16px;
        }

        .topright {
            grid-column: 30 / 49;
            grid-row: 1 / 12;
            margin: 0px;
            border: 2px solid;
            background-color: #005000;
            text-align: center;
            color: #007000;
            font-size: 12px;
            /* line-height: 20vh; */
        }

        .left {
            grid-column: 1 / 15;
            grid-row: 12 / 49;
            background-color: #707070;
            /* text-align: center; */
            /* line-height: 80vh; */
            font-size: 24px;

            box-sizing: border-box;
            /* padding: 5px; */
            flex: 1;
            overflow-y: auto;
            /* position: fixed; */
        }

        .right {
            grid-column: 15 / 49;
            grid-row: 12 / 49;
            background-color: #909090;
            overflow-y: auto;
            /*text-align: center;*/
            /*line-height: 80vh;*/
            /* font-size: 20px; */
            /* box-sizing: border-box; */
            /* flex: 1; */
            /* overflow: auto; */
        }

        .toggle-group {
            /* margin-bottom: 5px; */
            background-color: transparent;
        }

        .toggle-group button {
            padding: 10px 10px;
            /* margin: 5px; */
            border: 2px solid;
            /* cursor: pointer; */
            /* border-radius: 6px; */

            background: #007000;
            color: #00aa00;
            border-color: #00aa00;
        }

        .toggle-group .active {
            background: #007000;
            color: #00ff00;
            border-color: #00ff00;
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <div class="topleft">

            <input id="allfile" type="file" name="file" accept="image/*,video/*" hidden="true"
                onchange="selectFile(event)" />

            <div id="drop-zone" onclick="openFile('allfile')">
                <label style="text-align:center;">ÊãâÊ™îÊ°àÂà∞ÈÄôË£°</label><br>
                <progress id="prog" value="0" max="100"></progress><br>
                <label id="msg" style="text-align:center;">--</label><br>
                <label id="filename" style="text-align:center;">--</label><br>
            </div>
        </div>

        <div class="topright">
            <!-- <button onclick="openFile('allfile')">ÈÅ∏Ê™îÊ°à</button><br> -->
            <p></p>
            <button onclick="listFolder()" id="reload">ÈáçÊñ∞ËºâÂÖ•</button>
            <button onclick="download()">Ê™îÊ°à‰∏ãËºâ</button>
            <button onclick="deleteFile()" style="background-color: #ff0000;">Âà™Èô§</button>
            <p></p>
            <label id="selfile" style="color:#ffffff;text-align:center;font-size: 12px;word-wrap: break-word">--</label><br>
        </div>


        <div id="divfolder" class="left">
            <div id="togglediv" class="toggle-group" data-group="1">
            </div>
        </div>
        <div id="divfiles" class="right">
            <div id="togglediv2" class="toggle-group" data-group="2">
            </div>
        </div>
    </div>


    <script>

        const dropZone = document.getElementById('drop-zone');
        const msg = document.getElementById('msg');
        const filename = document.getElementById('filename');
        const selfile = document.getElementById('selfile');

        var user = 'guest';
        var folders = [];
        var activeFile = '';
        var activeFolder = '';

        function deleteFile() {
            if (activeFile.trim().length == 0) return;
            _ajax({
                action: "delfile",
                p1: activeFile,
                user: null
            },
                '/filesaction',
                (res) => {
                    //document.getElementById('reload').click();// location.reload();
                    if (activeFolder.trim().length == 0) return;
                    listFiles(activeFolder);
                }, (err) => {
                    alert('fail');
                });
        }

        function download() {
            if (activeFile.trim().length == 0) return;
            const url = activeFile;//"https://example.com/files/demo.pdf";
            // Âª∫Á´ã‰∏ÄÂÄãÈö±ËóèÁöÑ <a> ‰æÜËß∏Áôº‰∏ãËºâ
            const a = document.createElement("a");
            a.href = url;
            a.download = ""; // ÈÄôË£°ÂèØ‰ª•ÊåáÂÆöÊ™îÂêçÔºå‰æãÂ¶Ç "myfile.pdf"
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function _ajax(json, url, cb, errorcb) {
            console.log(json);
            fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(json)
            }).then((response) => {
                if (response.ok) {
                    return response.json(); // Ëß£ÊûêJSONÂõûÊáâ
                } else {
                    throw new Error("Ë´ãÊ±ÇÂ§±ÊïóÔºö" + response.status);
                }
            }).then((data) => {
                // Âú®ÈÄôË£°ËôïÁêÜËß£ÊûêÂæåÁöÑJSONÁâ©‰ª∂ //console.log(data);
                cb(data);
            }).catch((error) => {
                // ËôïÁêÜÈåØË™§
                console.log('' + error);
                errorcb();
            });
        }

        function createButton(caption, onClick) { //{ text, imgSrc, onClick, title }) {

            const btn = document.createElement('button');
            btn.innerHTML = 'üìÅ ' + caption;
            btn.style.width = '90%';
            btn.style.fontSize = '20px';

            btn.addEventListener('click', onClick);

            return btn;
        }

        function isImageFile(filename) {
            // ÂÆöÁæ©Â∏∏Ë¶ãÁöÑÂúñÁâáÂâØÊ™îÂêç
            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg'];

            // ËΩâÂ∞èÂØ´‰æÜÈÅøÂÖçÂ§ßÂ∞èÂØ´ÂïèÈ°å
            const lower = filename.toLowerCase();

            // Áî® some() ‰æÜÂà§Êñ∑ÊòØÂê¶Á¨¶ÂêàÂÖ∂‰∏≠‰∏ÄÂÄãÂâØÊ™îÂêç
            return imageExtensions.some(ext => lower.endsWith(ext));
        }

        function createImage(path, fn) {
            const btn = document.createElement('button');
            btn.style.width = '30%';
            btn.style.height = '30%';
            // btn.style.border = '2px solid';
            //let queryValue = "John Doe & Co.";
            //console.log('src:' + src);
            //src = encodeURIComponent(src);
            //console.log('after src:' + src);
            const img = document.createElement('img');
            img.src = path + '/' + fn;
            img.title = fn;
            img.style.width = "100%";//width;   // Âõ∫ÂÆöÂØ¨Â∫¶
            img.style.height = "100%";//height; // Âõ∫ÂÆöÈ´òÂ∫¶

            // ËÆìÂúñÁâáÂú®Âõ∫ÂÆöÊ°ÜÂÖß‰øùÊåÅÊØî‰æã
            img.style.objectFit = 'contain';  // Êàñ 'cover'
            //img.style.backgroundColor = '#000000';
            //img.style.cursor = "pointer"; // ÊªëÈº†ÁßªÈÅéÂéªËÆäÊàêÊâãÂûã
            //img.style.borderColor = "#ffff00";
            //img.parent = btn;

            //img.addEventListener("click", () => { window.open(img.src, "_blank", "width=800,height=600");});

            btn.appendChild(img);
            btn.addEventListener("dblclick", (e) => {
                try {
                    window.opener.pushFromUpload(img.src);
                } catch (e) {
                    window.open(img.src, "_blank", "width=800,height=600");
                }
            });


            btn.addEventListener("click", (e) => {
                activeFile = img.src;
                selfile.innerText = decodeURIComponent(new URL(activeFile).pathname);
            });

            /*
            img.addEventListener("click", (e) => {
                const group = document.querySelector(".toggle-group2");
                group.querySelectorAll("button").forEach(btn => btn.classList.remove("active2"));
                //alert(e.target.parentNode);
                e.target.parentNode.classList.add("active2");
            });
            */

            return btn;
        }

        function createFileButton(path, fn) { //{ text, imgSrc, onClick, title }) {

            const btn = document.createElement('button');
            btn.innerHTML = 'üìÑ ' + fn;
            btn.style.width = '30%';
            btn.style.height = '30%';
            // btn.style.border = '2px solid';

            btn.style.fontSize = '14px';

            let src = path + '/' + fn;
            btn.addEventListener('dblclick', (e) => {
                const fullUrl = new URL(src, window.location.origin).href;
                try {
                    window.opener.pushFromUpload(fullUrl);
                } catch (e) {
                    window.open(fullUrl, "_blank", "width=800,height=600");
                }
            });


            btn.addEventListener("click", (e) => {
                const fullUrl = new URL(src, window.location.origin).href;
                activeFile = fullUrl;
                selfile.innerHTML = decodeURIComponent(new URL(activeFile).pathname);
            });

            return btn;
        }

        /*
        let result = await doChk();
        if (result.state <= 0) return;
        if (result.username == 'guest' && result.state == 2) return;
        let user = result.username;
        */
        function listFolder(e) {
            //console.log('action:' + action + ', p1:' + p1);
            _ajax({
                action: "listfolders",
                p1: "",
                user: null
            }, '/filesaction',
                (obj) => {
                    console.log(JSON.stringify(obj));
                    let div = document.getElementById('togglediv');//'divfolder');
                    div.innerHTML = "";
                    let array = obj['folders'];
                    array.sort();
                    array.reverse();
                    let firstB = null;
                    array.forEach(element => {

                        let b = createButton(element, function (e) {
                            listFiles(element);
                            activeFile = '';
                            selfile.innerText = activeFile;
                            activeFolder = element;
                            //const group = document.querySelector(".toggle-group");
                            //group.querySelectorAll("button").forEach(btn => btn.classList.remove("active"));
                            //e.target.classList.add("active");
                        });
                        div.appendChild(b);
                        div.insertAdjacentHTML('beforeend', '<br>');
                        if (!firstB) firstB = b;
                    });
                    firstB.click();
                    //if (array.length > 0) listFiles(array[0]);

                }, (err) => {
                    alert('list folder fail');
                });

        }

        function listFiles(folder) {
            selfile.innerText = '';
            _ajax({
                action: "listfiles",
                p1: folder,
                user: null
            }, '/filesaction',
                (obj) => {
                    console.log(JSON.stringify(obj));
                    let div = document.getElementById('togglediv2');
                    div.innerHTML = "";
                    let array = obj['files'];
                    array.sort();
                    array.reverse();
                    array.forEach(element => {
                        //let src = encodeURIComponent(element);
                        //let encodedString = URLEncoder.encode(element, "UTF-8");
                        //console.log('::: ' + element);
                        if (isImageFile(element)) {
                            let btn = createImage('./users/uploads/' + obj.folder, element);
                            div.appendChild(btn);
                        } else {
                            let btn = createFileButton('./users/uploads/' + obj.folder, element);
                            //btn.style.verticalAlign = 'top';
                            div.appendChild(btn);
                        }
                        //div.insertAdjacentHTML('beforeend', '<br>');
                    });
                }, (err) => {
                    alert('list files fail: ' + err);
                });
        }

        /*
        function folderGo() {

            let folder_value = document.getElementById("folder").value;

            _ajax({
                action: "addfolder",
                p1: folder,
                user: null
            },
                '/filesaction',
                (res) => {
                    location.reload();
                }, (err) => {
                    alert('fail');
                });

        }
        */

        function selectFile(event) {

            //let file = event.target.files[0]; uploadFiles(files)
            let files = event.target.files;
            uploadFiles(files);
            //üìÅüìÇ

            /*
            var fileInfo = "Ê™îÊ°àÂêçÁ®±: " + file.name + "<br>" +
                                         "Ê™îÊ°àÈ°ûÂûã: " + file.type + "<br>" +
                                         "Ê™îÊ°àÂ§ßÂ∞è: " + file.size + " bytes";
            alert(fileInfo);
            */

            /*
            if (file.type.startsWith('text/html')) {
                displayHTMLFile(file);
                return;
            }
        
            if (file.type.startsWith('image/')) {
                displayImageFile(file);
                return;
            }
            
            if (file.type.startsWith('video/')) {
                displayVideoFile(file);
                return;
            }

            if (file.type.startsWith('application/pdf')) {
                displayPDFFile(file);
                return;
            }
            */
        }


        function openFile(elmid) {
            document.getElementById(elmid).click();
        }

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault(); //dropZone.style.borderColor = '#333';
        });

        dropZone.addEventListener('dragleave', () => {
            //dropZone.style.borderColor = '#aaa';
        });

        function _upload(file) {

            document.getElementById("prog").value = 0;

            const formData = new FormData();
            formData.append('file', file);

            filename.innerText = file.name;

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload');

            xhr.upload.onprogress = function (e) {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    //console.log('=' + e + '=');
                    msg.innerText = percent.toFixed(1) + '%';
                    document.getElementById("prog").value = percent;
                    //entry.querySelector('progress').value = percent;
                    //entry.querySelector('.status').innerText = percent.toFixed(1) + '%';
                }
            };

            xhr.onload = function () {
                if (xhr.status === 200) {
                    msg.innerText = 'ÂÆåÊàê';
                    listFolder();
                    //document.getElementById("prog").value = 0;
                } else {
                    msg.innerText = 'Â§±Êïó';
                    document.getElementById("prog").value = 0;
                }
                filename.innerText = '';
            };

            xhr.send(formData);
        }

        function uploadFiles(files) {
            const formData = new FormData();
            for (const file of files) {
                _upload(file);
            }
        }

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); //dropZone.style.borderColor = '#aaa';
            const files = e.dataTransfer.files;
            uploadFiles(files);
        });

        listFolder();

        document.querySelectorAll(".toggle-group").forEach(group => {
            group.addEventListener("click", (e) => {
                //console.log('--------------------' + e.target.tagName);
                if (e.target.tagName === "BUTTON") {
                    // Ê∏ÖÈô§Ë©≤ÁµÑÊâÄÊúâ active
                    group.querySelectorAll("button").forEach(btn => btn.classList.remove("active"));
                    // Ë®≠ÂÆöÁõÆÂâçÈªûÊìäÁöÑ active
                    e.target.classList.add("active");
                    //console.log('BUTTON e.target.src:' + e.target.src);
                } else if (e.target.tagName === "IMG") {
                    group.querySelectorAll("button").forEach(btn => btn.classList.remove("active"));
                    // Ë®≠ÂÆöÁõÆÂâçÈªûÊìäÁöÑ active
                    e.target.parentNode.classList.add("active");
                    //console.log('e.target.src:' + e.target.src);
                }

            });
        });


        //listFiles('20250718');

        /*
        function uploadFiles(files) {
            const formData = new FormData();
            for (const file of files) {
                formData.append('file', file);
            }

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
                .then(res => res.text())
                .then(text => msg.innerText = text)
                .catch(err => msg.innerText = 'Upload failed.');
        }
        */
    </script>
</body>

</html>