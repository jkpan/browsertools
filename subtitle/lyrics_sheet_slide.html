<!DOCTYPE html>
<script type="text/javascript" src="../common.js" charset="UTF-8"></script>
<html>

<head>
    <meta name="viewport"
        content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height"
        charset="UTF-8" />
    <style>
        body {
            margin: 0% 0%;
            height: 100%;
            width: 100%;
            border: none;
            background-color: #222;
        }

        .wrapper {
            position: fixed;
            gap: 0px;
            width: 100%;
            height: 100%;
            border: none;
        }

        .full {
            user-select: none;
            border: none;
            width: 100%;
            height: 100%;
        }

        .transDiv {

            width: 100%;
            height: 100%;
            border: none;

            position: absolute;
            left: 0;
            top: 0;

            display: flex;

            border-radius: 20px;

            /* 过渡动画 */
            /* transition: all 0.5s; */
            /* transform-origin: 0% 0%; */
            /* transform: rotate(0deg); */

            overflow-y: hidden;
            overflow-x: hidden;
        }

        .fullRange {
            margin: auto;
            width: 94%;
            height: 94%;

            position: absolute;
            top: 3%;
            left: 3%;
            right: 3%;
            bottom: 3%;

            user-select: none;

            border-radius: 15px;
            border: 5px dashed rgba(128, 0, 0, 0.7);
        }

        .fullRange2 {
            margin: auto;
            width: 0%;
            height: 0%;
        }

        iframe {
            border: none;
        }

        ::-webkit-scrollbar {
            display: none;
        }

        .img_ratio {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;

            position: absolute;
            /* 設定絕對定位 */
            top: 50%;
            /* 垂直置中 */
            left: 50%;
            /* 水平置中 */
            transform: translate(-50%, -50%);
            /* 修正到圖片的中心 */

        }

        .img_full {
            max-width: 100%;
            max-height: 100%;
        }

        button {
            font-size: 24px;
            background-color: transparent;
            color: #00ff00;
            margin: 1% 1%;
            border: 2px solid;
            vertical-align: middle;
        }

        /* 頁碼顯示 */
        .dots {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 18px;
            display: flex;
            gap: 30px;
            z-index: 60;
        }

        .dot {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: rgba(0, 200, 0, 0.3);
            border-color: green;
        }

        .dot.active {
            background: rgba(255, 0, 0, 0.5);
            width: 35px;
            border-radius: 999px;
            transition: width 160ms;
        }
    </style>
</head>

<body>
    <div id="container" class="wrapper"></div>
    <div id="dots" class="dots" aria-hidden="false"></div>
</body>

</html>

<script>

    const items = [];
    var current = -1;
    var animType = 2;
    const dotsContainer = document.getElementById('dots');
    var startX;
    var total;

    function add2Item(_div) {

        //_div.style.transition = 'none';

        let parent = document.getElementById('container');
        parent.appendChild(_div);
        items.push(_div);

        _div.style.top = '0px';
        _div.style.left = (items.length - 1 - current) * window.innerWidth + "px";
        _div.style.opacity = 1.0;
        _div.style.transform = "rotate(0deg)";
        _div.style.transition = 'all 0.25s';

        current = items.length - 1;

        framePos();

        /*
        setTimeout(() => {
            current = items.length - 1;
            framePos();
        }, 100);
        */

    }

    function newDiv() {
        const _div = document.createElement('div');
        _div.className = 'transDiv';
        return _div;
    }

    function reload() {
        let d = document.getElementById("web");
        document.getElementById("web").src = d.src;
    }

    function isImageFile(filename) {
        // 定義常見的圖片副檔名
        const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg'];

        // 轉小寫來避免大小寫問題
        const lower = filename.toLowerCase();

        // 用 some() 來判斷是否符合其中一個副檔名
        return imageExtensions.some(ext => lower.endsWith(ext));
    }

    function urlGo(value, /*loop, key,*/ keepratio /*, ctrl*/) {

        value = value.trim();
        if (value.length == 0) return;

        let div = newDiv();

        div.hidden = false;

        if (value.toLowerCase().endsWith('pdf')) {
            const iframe = document.createElement('iframe');
            iframe.setAttribute("width", "100%");
            iframe.setAttribute("height", "100%");
            iframe.src = value;
            //iframe.style.objectFit = 'contain';
            //iframe.allow = 'fullscreen';
            div.appendChild(iframe);
            add2Item(div);
            return;
        }

        const img = document.createElement('img');
        img.src = value;
        img.style.width = "100%";//width;   // 固定寬度
        img.style.height = "100%";//height; // 固定高度

        if (keepratio) {
            img.style.objectFit = 'contain';  // 或 'cover'
        } else {
            img.style.objectFit = 'fill';
        }
        // 讓圖片在固定框內保持比例

        img.style.backgroundColor = '#000000';
        //img.style.border = '2px solid red';
        div.appendChild(img);
        add2Item(div);

    }

    function updateDots() {
        const dots = dotsContainer.children;
        for (let i = 0; i < dots.length; i++) {
            dots[i].classList.toggle('active', i === current);
        }
    }

    function framePos() {
        for (let i = 0; i < items.length; i++) {
            let div = items[i]; //let div = document.getElementById('content_' + i);
            div.style.opacity = 1.0;
            div.style.left = (i - current) * window.innerWidth + "px";
            div.style.top = "0px";
            //div.style.transform = "rotate(0deg)";
        }
        updateDots();
    }


    function goAddMoveLeft() {
        current++;
        if (current >= items.length)
            current = items.length - 1;
        framePos();
    }

    function goSubMoveRight() {
        current--;
        if (current < 0)
            current = 0;
        framePos();
    }

    window.addEventListener('resize', function () {
        framePos();
    });

    function jump2(idx) {
        if (idx >= items.length) return;
        current = idx;
        framePos();
    }

    function goToIndex(i) {
        let idx = Math.max(0, Math.min(total - 1, i));
        jump2(idx);
    }

    function getClientX(evt) {
        if (!evt) return null;
        if (evt.type && evt.type.startsWith('touch')) {
            const t = (evt.touches && evt.touches[0]) || (evt.changedTouches && evt.changedTouches[0]);
            return t ? t.clientX : null;
        }
        // mouse event may be on window (mouseup) and not have clientX; try evt.clientX
        return evt.clientX ?? (evt.changedTouches ? (evt.changedTouches[0] && evt.changedTouches[0].clientX) : null);
    }

    function simpleTouch(evt) {
        if (startX > window.innerWidth / 2 && getClientX(evt) > window.innerWidth / 2) {
            goAddMoveLeft();
            return;
        }
        if (startX < window.innerWidth / 2 && getClientX(evt) < window.innerWidth / 2) {
            goSubMoveRight();
            return;
        }
    }

    window.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') goSubMoveRight();
        if (e.key === 'ArrowRight') goAddMoveLeft();
    });

    window.addEventListener('mousedown', (evt) => {
        startX = getClientX(evt); //console.log('mousedown ' + startX);
    });

    window.addEventListener('mouseup', (evt) => {
        simpleTouch(evt); //console.log('mouseup ');
    });

    function init(images) {
        if (!images) {
            images = window.opener.getSheetArray();
            total = images.length;
        }
        
        total = images.length;

        images.forEach((src, i) => {
            urlGo(src, true);
            //console.log(' ---- ---- src : ' + src);
            const dot = document.createElement('div');
            dot.className = 'dot' + (i === 0 ? ' active' : '');
            dot.dataset.idx = i;
            dot.title = `${i + 1}/${images.length}`;
            dot.style.cursor = 'pointer';
            dot.addEventListener('click', () => goToIndex(i));
            dotsContainer.appendChild(dot);

        });
        if (readParam('idx')) {
            let idx = readParam('idx');
            for (let i = 0; i < images.length; i++) {
                if (decodeURI(images[i]).indexOf(idx) != -1) {
                    jump2(i);
                    //setTimeout(() => {  }, 100 * images.length + 100);
                    break;
                }
            }
        }

    }

    function _ajax(json, url, cb, errorcb) {
        console.log(json);
        fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(json)
        }).then((response) => {
            if (response.ok) {
                return response.json(); // 解析JSON回應
            } else {
                throw new Error("請求失敗：" + response.status);
            }
        }).then((data) => {
            // 在這裡處理解析後的JSON物件 //console.log(data);
            cb(data);
        }).catch((error) => {
            // 處理錯誤
            console.log('' + error);
            errorcb();
        });
    }

    function getSongList(songid) {
        _ajax({
                action: "listbysongid",
                p1: songid,
                user: null
            }, '/sheetaction',
                (obj) => {
                    let array = obj['files'];
                    array.sort(); //array.reverse();
                    for (let i=0;i<array.length;i++) {
                        array[i] = '.' + obj.folder + '/' + array[i];
                    }

                    init(array);

                    /*
                    array.forEach(element => {

                        //let src = encodeURIComponent(element);
                        //let encodedString = URLEncoder.encode(element, "UTF-8");
                        try {
                            let array = element.split('__');
                            let idx = parseInt(array[1]);//array[0];
                            let div = document.getElementById('drop-zone-' + idx);
                            div.innerHTML = '';
                            div.style.backgroundColor = 'transparent';
                            if (isImageFile(element)) {
                                let img = createImage('.' + obj.folder, element);//img.id = 'img_' + idx;
                                sheetArray.push(img.src);
                                div.appendChild(img);
                                if (doUpload)
                                    div.appendChild(createDelButton(idx));
                            } else if (element.toLowerCase().endsWith('.pdf')) {
                                let src = '.' + obj.folder + '/' + element;
                                let img = createPDFBtn(element);//('.' + obj.folder, element);img.id = 'img_' + idx;
                                sheetArray.push(src);
                                div.appendChild(img);
                                if (doUpload)
                                    div.appendChild(createDelButton(idx));
                            }
                        } catch (err) {
                            alert(err);
                            return;
                        }
                    });
                    */
                },
                (err) => {
                    alert('list files fail: ' + err);
                });
    }

    if (readParam('songid') && readParam('songid').length > 0) {
        getSongList(readParam('songid'));
    } else {
        init();
    }


</script>