<!DOCTYPE html>
<script type="text/javascript" src="common.js" charset="UTF-8"></script>
<script type="text/javascript" src="login.js" charset="UTF-8"></script>
<script type="text/javascript" charset="UTF-8">

  var tabCount = 7;

  var tool_Bible = 'subtitle_b.html';
  var tool_index = 'tools.html';//'effect.html';

</script>
<html>

<head>
  <meta name="viewport"
    content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height"
    charset="UTF-8" />
  <style>
    body {
      margin: 0px;
      height: 100%;
      width: 100%;
      background-color: black;
    }

    ::-webkit-scrollbar {
      display: none;
    }

    .wrapper {
      gap: 0px;
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: fixed;
    }

    .container {

      width: 100%;
      height: 100%;

      position: absolute;
      left: 0;
      top: 0;

      display: flex;

      /* 过渡动画 */
      transition: opacity 0.5s;

      transform-origin: 0% 0%;
      transform: rotate(0deg);

      overflow-y: hidden;
      overflow-x: hidden;
    }

    .button {
      background-color: rgb(0, 180, 0);
      border-color: rgb(0, 180, 0);
      color: rgb(0, 255, 0);
      border-radius: 8px;

      font-size: 16px;
      margin: 2px 2px;

      width: 28px;
      height: 40%;

      text-align: center;
      padding: 4px;
    }

    .okbutton {
      background-color: rgb(0, 100, 0);
      border-color: #00ff00;
      color: rgb(0, 255, 0);
      border-radius: 8px;

      font-size: 14px;
      margin: 1px 1px;

      width: 48px;
      height: 40%;

      text-align: center;
      text-decoration: none;

      padding: 4px;

      display: inline-block;
    }

    .cancelbutton {
      background-color: rgb(0, 144, 0);
      border-color: #00ff00;
      color: rgb(0, 255, 0);
      border-radius: 8px;

      font-size: 15px;
      margin: 1px 1px;

      width: 48px;
      height: 40%;

      text-align: center;
      text-decoration: none;

      padding: 4px;

      display: inline-block;
    }

    .sideMenu {

      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;

      position: fixed;

      top: 0;
      left: 0px;
      /* 初始位置在左侧屏幕外 */
      width: 100%;
      height: 100px;
      background-color: rgb(0, 90, 0);
      color: #fff;

      transition: top 0.3s;
      /* 添加过渡效果 */
      z-index: 90;
    }

    .btncontainer {
      grid-column: 1 / 11;
      grid-row: 1 / 11;
      direction: ltr;
      text-align: left;
    }

    .right-to-left {
      grid-column: 8 / 11;
      grid-row: 2 / 10;
      direction: rtl;
      text-align: right;
    }

    .menuButton {
      background-color: transparent;
      border-color: #008000;
      color: rgb(0, 255, 0);
      border-radius: 4px;
      opacity: 0.33;
      position: fixed;
      z-index: 91;
    }

    label {
      color: #00ee00;
    }
  </style>
  <title>Tabs</title>
</head>

<body>

  <div class="wrapper" style="background-color: #000000; opacity: 1.0;">
    <div id="content_1" class="container" style="background-color: transparent;margin: 0px;opacity: 1.0;">
      <iframe id="frame_1" frameborder="0" width="100%" height="100%" align="left" src=""></iframe>
    </div>

    <div id="content_2" class="container" style="background-color: transparent;margin: 0px;opacity: 1.0;">
      <iframe id="frame_2" frameborder="0" width="100%" height="100%" align="right" src=""></iframe>
    </div>

    <div id="content_3" class="container" style="background-color: transparent;margin: 0px;opacity: 1.0;">
      <iframe id="frame_3" frameborder="0" width="100%" height="100%" align="right" src=""></iframe>
    </div>

    <div id="content_4" class="container" style="background-color: transparent;margin: 0px;opacity: 1.0;">
      <iframe id="frame_4" frameborder="0" width="100%" height="100%" align="right" src=""></iframe>
    </div>

    <div id="content_5" class="container" style="background-color: transparent;margin: 0px;opacity: 1.0;">
      <iframe id="frame_5" frameborder="0" width="100%" height="100%" align="right" src=""></iframe>
    </div>

    <div id="content_6" class="container" style="background-color: transparent;margin: 0px;opacity: 1.0;">
      <iframe id="frame_6" frameborder="0" width="100%" height="100%" align="right" src=""></iframe>
    </div>

    <div id="content_7" class="container" style="background-color: transparent;margin: 0px;opacity: 1.0;">
      <iframe id="frame_7" frameborder="0" width="100%" height="100%" align="right" src=""></iframe>
    </div>
  </div>

  <input id="jsonfile" type="file" accept=".json" hidden="true" onchange="selectSetting(event)" />

  <button id="menubtn" class="menuButton" style="top:10px;left:10px;" onclick="sideClick()">-</button>

  <div class="sideMenu" id="sideMenu">
    <div class="btncontainer">
      &nbsp;
      &nbsp;
      &nbsp;
      &nbsp;
      <button id="btn_1" class="button" onclick="switchFunction(1)">1</button>
      <button id="btn_2" class="button" onclick="switchFunction(2)">2</button>
      <button id="btn_3" class="button" onclick="switchFunction(3)">3</button>
      <button id="btn_4" class="button" onclick="switchFunction(4)">4</button>
      <button id="btn_5" class="button" onclick="switchFunction(5)">5</button>
      <button id="btn_6" class="button" onclick="switchFunction(6)">6</button>
      <button id="btn_7" class="button" onclick="switchFunction(7)">7</button>
      <br>
      &nbsp;
      &nbsp;
      &nbsp;
      &nbsp;
      <button class="okbutton" onclick="reloadFrame()">R</button>
      <button class="okbutton" onclick="openCtrl()">C</button>
      <button id="aBtn" class="okbutton" onclick="setSlideAnim()">a1</button>
      &nbsp;
      <button id="btn_preload_1" class="button" onclick="preload(1)">#1</button>
      <button id="btn_preload_2" class="button" onclick="preload(2)">#2</button>
      <button id="btn_preload_3" class="button" onclick="preload(3)">#3</button>
      <button id="btn_preload_4" class="button" onclick="preload(4)">#4</button>
      <button id="btn_preload_5" class="button" onclick="preload(5)">#5</button>
      <button class="cancelbutton" onclick="loadJson()">#</button>
      <button class="cancelbutton" onclick="downloadExpJson()">exp</button>
      <button id="btn_save_1" class="button" onclick="savefile(1)">1^</button>
      <button id="btn_save_2" class="button" onclick="savefile(2)">2^</button>
      <button id="btn_save_3" class="button" onclick="savefile(3)">3^</button>
      <button id="btn_save_4" class="button" onclick="savefile(4)">4^</button>
      <button id="btn_save_5" class="button" onclick="savefile(5)">5^</button>
      &nbsp;
      <label id="closebar" style="color: #00ee00;" onclick="sideClick()">x</label>
    </div>
    <div class="right-to-left">
      &nbsp;
      <label id="__username" hidden="true"></label>
      &nbsp;
      <label id="__login" style="border: 1px solid #0f0;" hidden="true" onclick="login()">Sign in</label>
      &nbsp;
      <label id="__logout" style="border: 1px solid #0f0;" hidden="true" onclick="logout()">Sign out</label>
      &nbsp;
    </div>


  </div>

</body>

</html>

<script type="text/javascript" charset="UTF-8">

  function closeLogin() {
    if (_login)
      _login.close();
    _login = null;
  }

  let sideMenu = document.getElementById('sideMenu');
  sideMenu.style.top = '0px';

  function openSideMenu() {
    let sideMenu = document.getElementById('sideMenu');
    sideMenu.style.top = '0';
  }

  function closeSideMenu() {
    let sideMenu = document.getElementById('sideMenu');
    sideMenu.style.top = '-120px';
  }

  function sideClick() {
    let sideMenu = document.getElementById('sideMenu');
    if (sideMenu.style.top == '-120px') {
      openSideMenu();
    } else {
      closeSideMenu();
    }
  }

  //document.getElementById("menubtn").addEventListener('mouseenter', e => {sideClick();});

  /*
  sideMenu.addEventListener('mouseup', (e) =>{
    closeSideMenu();
  });
  
  let mbar = document.getElementById("sideMenu");
  mbar.addEventListener('mouseleave', e => {
    closeSideMenu();
  });
  */

  function resetFrame() {
    for (let i = 1; i <= tabCount; i++) {
      document.getElementById('frame_' + i).src = tool_index;
      //document.getElementById('content_'+i).style.left = (i-1) * window.innerWidth + "px";
      //console.log(window.innerWidth + ', ' + window.innerHeight);.left = index * width * -1 + "px";
    }
  }

  function reloadFrame() {
    let src = document.getElementById('frame_' + tab).getAttribute('src');//console.log('tab:' + tab + ': ' + src);
    document.getElementById('frame_' + tab).setAttribute('src', src);
  }

  function getRootUrl() {
    let all = window.location.href; //console.log(all);
    let root = all.substr(0, all.length - '/tabs.html'.length); //console.log('root:' + root);
    return root;
  }

  function relativeUrl(url) {
    let root = getRootUrl();//let domain = window.location.origin;
    if (url.startsWith(root)) {
      let str = url.substr(root.length, url.length - root.length);
      console.log(str);
      return '.' + str;
    }
    return url;
  }

  function _ajax(json, url, cb, errorcb) {
    console.log(json);
    fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(json)
    }).then((response) => {
      if (response.ok) {
        return response.json(); // 解析JSON回應
      } else {
        throw new Error("請求失敗：" + response.status);
      }
    }).then((data) => {
      // 在這裡處理解析後的JSON物件 //console.log(data);
      cb(data);
    }).catch((error) => {
      // 處理錯誤
      console.log('' + error);
      errorcb();
    });
  }

  function ajax_savejson(fn, json) {
    _ajax({
      filename: fn,
      content: json
    },
      '/savejson',
      (res) => { console.log(JSON.stringify(res)); },
      () => { console.log('exception'); }
    );
  }

  function savefile(idx) {
    if (username == null) return;
    let fn = `./usr/${username}/tab_0${idx}.json`;
    if (confirm(`確定要存入 #${idx} ?`))
      ajax_savejson(fn, JSON.stringify(toObj()));
  }

  /*
    frame_1 ~ 7
    src
    obj
   */
  function toObj() {
    let obj = {}
    for (let i = 1; i <= tabCount; i++) {
      obj['frame_' + i] = {};
      let frameObj = obj['frame_' + i];
      let url = document.getElementById('frame_' + i).src;
      url = relativeUrl(url);
      frameObj['src'] = url;//document.getElementById('frame_'+i).src;
      frameObj['obj'] = {};
      try {
        let _obj = document.getElementById('frame_' + i).contentWindow.toObj();
        if (_obj) {
          frameObj['obj'] = _obj;
        }
      } catch (e) {
        //frameObj['obj'] = { "url" : "xx" }
      }
    }
    return obj;
  }

  function downloadExpJson() {
    let str = JSON.stringify(toObj(), null, "\t");
    console.log(str);
    var downloadLink = document.createElement("a");
    downloadLink.setAttribute("href", "data:text/plain;charset=utf-8," + str);
    downloadLink.setAttribute("download", "tabs_setting.json"); // 设置下载文件的名称，此处为myFile.txt
    // 4. 使用JavaScript模拟用户点击下载链接，从而触发下载
    downloadLink.click();
  }

  function preload(idx) {
    if (username == null) return;
    let url = `./usr/${username}/tab_0${idx}.json`;
    fetch(url).then((response) => {
      return response.json();
    }).then((json) => {
      handleProfile(json);
    }).catch((error) => {
      alert('Error' + error);
      console.log(`Error: ${error}`);
    });
  }

  function loadJson() {
    document.getElementById('jsonfile').click();
  }

  /*
    frame_1:
      src : 
      obj 
  */
  function handleProfile(jsonData) {
    //const fileContent = event.target.result;
    //const jsonData = JSON.parse(fileContent);
    //console.log(fileContent);
    resetFrame();
    for (let i = 1; i <= tabCount; i++) {
      let _f = 'frame_' + i;
      if (!jsonData[_f]) continue;
      let frame = document.getElementById(_f);
      if (jsonData[_f]['src'])
        frame.src = jsonData[_f]['src'];
      else
        continue;
      if (jsonData[_f]['obj'])
        frame.onload = function () {
          frame.contentWindow.postMessage(JSON.stringify(jsonData[_f]['obj']), '/');
        }
    }
    switchFunction(1);
    if (jsonData['ctrl'] && jsonData['ctrl'] == 1) {
      openCtrl();
    }
  }

  function selectSetting(event) {
    const inputFile = document.getElementById('jsonfile');
    if (inputFile.files.length == 0) return;
    // 讀取使用者選擇的檔案
    const file = inputFile.files[0];
    const reader = new FileReader();
    reader.readAsText(file);
    // 當讀取完成時，將檔案內容轉換成 JSON 物件並進行處理
    reader.onload = function (event) {
      const fileContent = event.target.result;
      const jsonData = JSON.parse(fileContent);
      console.log(fileContent);
      handleProfile(jsonData);
    }

  }

  var _openWin = null;
  function openCtrl() {
    closeCtrl();
    _openWin = window.open("tabs_ctrl.html", "");
    //_openWin = window.open("tabs_ctrl.html", "", "popup=no,toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=no,resizable=no,width=64,height=250,top="+(screen.height-400)+",left="+(screen.width-840));
  }

  function closeCtrl() {
    if (_openWin)
      _openWin.close();
    _openWin = null;
  }

  var action = '';
  var tab;
  var funcInterval;
  var animType = 1;

  function setSlideAnim() {

    animType = (animType + 1) % 5;

    var b = document.getElementById('aBtn');
    let caption = b.textContent;
    if (animType == 0) {
      b.textContent = '--';
    } else {
      b.textContent = 'a' + animType;//  <> ^v
    }

    for (let i = 1; i <= tabCount; i++) {
      switch (animType) {
        case 0: document.getElementById("content_" + i).style.transition = 'none'; break;
        // default: document.getElementById("content_" + i).style.transition = 'all 0.5s'; break;
        case 1: document.getElementById("content_" + i).style.transition = 'opacity 0.5s'; break;
        case 2:
        case 3: document.getElementById("content_" + i).style.transition = 'all 0.5s'; break;
        case 4: document.getElementById("content_" + i).style.transition = 'all 0.5s'; break;
      }
    }

    framePos();

  }

  function framePos() {
    switch (animType) {
      case 0:
      case 2:
        for (let i = 1; i <= tabCount; i++) {
          let div = document.getElementById('content_' + i);
          div.style.opacity = 1.0;
          div.style.left = (i - tab) * window.innerWidth + "px";
          div.style.top = "0px";
          div.style.transform = "rotate(0deg)";
        }
        break;
      case 4:
        for (let i = 1; i <= tabCount; i++) {
          let div = document.getElementById('content_' + i);
          div.style.opacity = 1.0;
          div.style.left = "0px";
          div.style.top = "0px";
          if (i <= tab) {
            div.style.transform = "rotate(0deg)";
          } else {
            div.style.transform = "rotate(90deg)";
          }
        }
        break;
      case 3:
        for (let i = 1; i <= tabCount; i++) {
          let div = document.getElementById('content_' + i);
          div.style.opacity = 1.0;
          div.style.left = "0px";
          div.style.top = (i - tab) * window.innerHeight + "px";
          div.style.transform = "rotate(0deg)";
        }
        break;
      case 1:
        for (let i = 1; i <= tabCount; i++) {
          let div = document.getElementById('content_' + i);
          div.style.transform = "rotate(0deg)";
          if (i == tab) {
            div.style.left = "0px";
            div.style.top = "0px";
            div.style.opacity = 1.0;
            //setTimeout(function () {  div.style.left = "0px";  }, 510);
          } else {
            div.style.opacity = 0;
            div.style.top = "0px";
            setTimeout(function () {
              div.style.left = window.innerWidth + "px";
            }, 500);
          }
        }
        break;
    }
  }

  function switchFunction(idx) {
    tab = idx;
    for (let i = 1; i <= tabCount; i++) {
      document.getElementById('btn_' + i).style.background = "rgb(0,112,0)";
      document.getElementById('btn_' + i).style.color = "rgb(0,80,0)";
      document.getElementById('btn_' + i).style.fontSize = '12px';
    }

    document.getElementById('btn_' + tab).style.background = "rgb(0,128,0)";
    document.getElementById('btn_' + tab).style.color = "rgb(0,255,0)";
    document.getElementById('btn_' + tab).style.fontSize = '16px';

    framePos();
    document.getElementById('frame_' + tab).focus();

    return document.getElementById('frame_' + tab);
  }

  function showPane(elm, show) {
    //div.hidden = !show;
    if (show) {
      elm.style.opacity = '0.8';
    } else {
      elm.style.opacity = '0.0';
    }
  }

  window.addEventListener('message', function (event) {

    console.log('message: ' + event.data);

    if (event.data == 'x' || event.data == 'o') {
      //startRestoreInterval();
    } else {
      try {
        handleProfile(JSON.parse(event.data));
      } catch (e) {
        let frame = document.getElementById('frame_' + tab);
        frame.src = event.data;
      }
    }

  });

  //大小變化
  window.addEventListener('resize', function () {
    framePos();
  });

  window.addEventListener('beforeunload', function (e) {
    closeCtrl();
    closeLogin();
  });

  resetFrame();
  switchFunction(1);

  var _login = null;
  var username = null;

  function logout() {
    cleanLogin();
    document.getElementById('__username').hidden = true;
    document.getElementById('__username').innerHTML = '';
    document.getElementById('__login').hidden = false;
    document.getElementById('__logout').hidden = true;
  }

  function login() {
    closeLogin();
    _login = window.open("login.html", "", "popup=no,toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=no,resizable=no,width=400,height=500,top=" + (screen.height - 400) + ",left=" + (screen.width - 840));
  }

  async function chkloginstatus() {
    let result = await doChk();
    handleLogin(result);
  }

  function handleLogin(resultJson) {
    document.getElementById('__username').hidden = true;
    document.getElementById('__login').hidden = true;
    document.getElementById('__logout').hidden = true;
    username = null;
    if (resultJson.state > 0) {
      username = resultJson.username;
      document.getElementById('__username').hidden = false;
      document.getElementById('__username').innerHTML = resultJson.username;
      if (resultJson.username != 'guest')
        document.getElementById('__logout').hidden = false;
      for(let i=1;i<=5;i++) {
        document.getElementById('btn_preload_' + i).hidden = false;
        document.getElementById('btn_save_' + i).hidden = false;
      }
    } else {
      document.getElementById('__login').hidden = false;
      for(let i=1;i<=5;i++) {
        document.getElementById('btn_preload_' + i).hidden = true;
        document.getElementById('btn_save_' + i).hidden = true;
      }
    }

  }

  chkloginstatus();

  /*
  if (readParam('json')) {
    let value = readParam('json');
    if (value)
      preload('./' + value);
  }
  */
  

</script>