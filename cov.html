
<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="keywords" content="COVID-19,COVID19,家用快篩試劑,家用快篩實名制,快篩試劑實名制,快篩試劑,快篩試劑哪裡買,剩餘數量,Open Data" />
<meta name="description" content="提供COVID-19家用快篩試劑剩餘數量即時查詢" />
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" sizes="32x32" />
<link rel="icon" href="https://ycchen.im.ncnu.edu.tw/favicon.png" sizes="192x192" />
<link rel="apple-touch-icon" sizes="180x180" href="https://ycchen.im.ncnu.edu.tw/favicon.png" />
<link rel="apple-touch-icon-precomposed" sizes="180x180" href="https://ycchen.im.ncnu.edu.tw/favicon.png" />
<title>COVID-19家用快篩試劑數量查詢</title>
<style type="text/css">
h1 {
color: ivory;
font-size: 14pt;
text-align: center;
}
main {
margin: 5px;
padding: 10px;
border-radius: 15px;
background-color: black;
}
#query {
color: ivory;
}

table {
margin: 0px auto;
}

td:nth-of-type(4){
text-align: center;
font-weight: bold;
color: red;
}
tr:nth-of-type(even) {
background-color: LightCyan;
}
tr:nth-of-type(even) td:first-child {
border-radius: 10px 0px 0px 0px;
}
tr:nth-of-type(even) td:last-child {
border-radius: 0px 10px 0px 0px;
}
tr:nth-of-type(odd) td:last-child {
border-radius: 0px 0px 10px 10px;
}
tr:nth-of-type(1) th:first-child {
border-radius: 10px 0px 0px 10px;
}
tr:nth-of-type(1) th:last-child {
border-radius: 0px 10px 10px 0px;
}
tr:nth-of-type(odd) {
background-color: mintCream;
}
tr:nth-of-type(odd) td {
/* border-bottom: 2px solid green; */
}
td {
padding: 3px 5px;

}
th {
color: white;
background-color: MidnightBlue;
padding: 5px;
}
th, td {
border-radius: 0px;
}
caption {
font-weight: bold;
padding: 15px;
font-size: 1.5em;
color: ivory;
}
#query {
margin: 10px auto;
width: 100%;
text-align: center;
}
select, input {
font-size:14pt;
}
#okBtn {
padding: 0px 3px;
}
.sel {
border-radius: 10px;
background-color: white;
color: red;
font-weight: bold;
}
input[id*=K] {
font-size: 12pt;
}
#map {
height: 1pc;
vertical-align: text-top;
margin: 0px;
}
a {
text-decoration: none;
}
#zero {
display: inline-block;
width: 100%;
text-align:center;
color: red;
font-size: 16pt;
font-weight: bold;
}
footer {
margin-top: 10px;
font-size: 0.9em;
color: ivory;
text-align: center;
}
footer a:link, footer a:visited {
color: #dfb;
}
#note {
display: block;
font-size: 0.75pc;
color: #dfb;
line-height: 0.8pc;
}
</style>
<script type="text/javascript" src="twCity.js"></script>
<script type="text/javascript">
var radius=15;
var count=0;
var titleArr=["藥局","地址","電話","數量"];
var maskArr;
window.onload = function() {
  cityInit();
  city.selectedIndex=9; // Nantou County
  showTown();
  $("town").selectedIndex=1; // Puli
  $("city").onchange=showTown;
  var xmlhttp=new XMLHttpRequest();
  var url="RTestQuery.php";
  try {
  xmlhttp.open("GET", url, true);
  xmlhttp.onreadystatechange=rsChange;
  xmlhttp.send(null);}
  catch(e) {
    alert(e.message);
  }
}
function cityInit() {
   var city=$("city");
   for (let cty in cityArr) {
      let opt=new Option();
	  opt.text=cty;
	  city.add(opt);
   }

}
function showTown() {
   clearTown();
   var cty=$("city").options[$("city").selectedIndex].text;
   for (let town of cityArr[cty]) {
      let opt= new Option();
	  opt.text=town;
      $("town").add(opt);
   }
}
function clearTown() {
   var town=$("town");
   var num=town.options.length;
   for (let i=0;i<num;i++) {
      town.remove(0);
   }
}
function rsChange() {
  if (this.readyState==4 && this.status==200) {
    var maskData = this.responseText;
	maskArr = JSON.parse(maskData);
	maskArr.sort(maskSort);
	$("okBtn").onclick=query;
	$("btn1K").onclick=geoQuery;
	$("btn3K").onclick=geoQuery;
	$("btn5K").onclick=geoQuery;
	$("btn10K").onclick=geoQuery;
    query();
  }
}
function geoQuery() {
   clearGeoBtn();
   var btn=this.id;
   $(btn).classList.add("sel");
   radius=this.value*1;
if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(queryByPos);
  } else {
    $("cont").innerHTML = "Geolocation is not supported by this browser.";
  }
}
function clearGeoBtn() {
   var arrBtn=document.querySelectorAll("input[id*=K]");
   for (let btn of arrBtn) {
      btn.classList.remove("sel");
   }
}
function queryByPos(position) {
  var lat1=position.coords.latitude;
  var lon1=position.coords.longitude;
  var tblStr=json2TableGeo(maskArr, [1,2,5,7],titleArr, "快篩試劑剩餘數量<br/>(鄰近"+radius+"公里內)", lat1,lon1);
  $("cont").innerHTML = tblStr;
}
function query() {
   clearGeoBtn();
   var town=$("city").options[$("city").selectedIndex].text+$("town").options[$("town").selectedIndex].text;
   var tblStr=json2Table(maskArr, [1,2,5,7],titleArr, "快篩試劑剩餘數量", town);
	$("cont").innerHTML= tblStr;
}
function maskSort(a, b) {
  return b[7]-a[7];
}
function json2Table(jsonObj, indexArr, titleArr, caption, town) {
  var tbl="<table>";
  
  tbl+="<tr>";
  for (let i=0;i<titleArr.length;i++) {
     tbl += "<th>"+titleArr[i]+"</th>";
  }
  tbl+="</tr>";
  count=0;
  for (let i=0;i<jsonObj.length;i++) {
      if (jsonObj[i][2].includes(town)) {
		count++;
		tbl += "<tr>";
		for (let j=0;j<indexArr.length;j++) {
		   if (indexArr[j]==2) {
		     let address='<a href="https://www.google.com.tw/maps/?q='+jsonObj[i][2]+'">'+jsonObj[i][2];
		     address += '<img id="map" src="mapIcon.png" /></a>';
			 tbl += "<td>"+address+"</td>";
		   }
		   else
		     tbl += "<td>"+jsonObj[i][indexArr[j]]+"</td>";
		}
		tbl += "</tr>";
		tbl += '<tr><td colspan="'+indexArr.length+'">';
		tbl += "備註："+jsonObj[i][9]+"</td></tr>";
      }
  }
  //tbl += "<caption>"+caption+"</caption>";
  tbl+="</table>";
  if (count==0)
     tbl = '<span id="zero">'+town+': 今日已售罄！</span>';
  return tbl;
}
function json2TableGeo(jsonObj, indexArr, titleArr, caption, lat1, lon1) {
  var tbl="<table>";
  tbl+="<tr>";
  for (let i=0;i<titleArr.length;i++) {
     tbl += "<th>"+titleArr[i]+"</th>";
  }
  tbl+="</tr>";
  count=0;
  for (let i=0;i<jsonObj.length;i++) {
      let dist=Math.round(geoDist(lat1, lon1, jsonObj[i][4], jsonObj[i][3], "K")*10)/10;
      if (dist<=radius) {
	    count++;
		tbl += "<tr>";
		for (let j=0;j<indexArr.length;j++) {
		   if (indexArr[j]==2) {
		     let address='<a href="https://www.google.com.tw/maps/?q='+jsonObj[i][2]+'">'+jsonObj[i][2];
		     address += '<img id="map" src="mapIcon.png" /></a>';
		     tbl += "<td>"+address+"</td>";
		   }
		   else
		     tbl += "<td>"+jsonObj[i][indexArr[j]]+"</td>";
		}
		tbl += "</tr>";
		tbl += '<tr><td colspan="'+indexArr.length+'">';
		tbl += "備註："+jsonObj[i][9]+"</td></tr>";
      }
  }
  //tbl += "<caption>"+caption+"</caption>";
  tbl+="</table>";
  if (count==0)
     tbl = '<span id="zero">鄰近'+radius+'km區域：今日已售罄！</span>';
  return tbl;
}
function $(id) {
   return document.getElementById(id);
}
function geoDist(lat1, lon1, lat2, lon2, unit) {
    if ((lat1 == lat2) && (lon1 == lon2)) {
        return 0;
    }
    else {
        var radlat1 = Math.PI * lat1/180;
        var radlat2 = Math.PI * lat2/180;
        var theta = lon1-lon2;
        var radtheta = Math.PI * theta/180;
        var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
        if (dist > 1) {
            dist = 1;
        }
        dist = Math.acos(dist);
        dist = dist * 180/Math.PI;
        dist = dist * 60 * 1.1515;
        if (unit=="K") { dist = dist * 1.609344 }
        if (unit=="N") { dist = dist * 0.8684 }
        return dist;
    }
}

</script>
</head>
<body>
<main>
<h1>快篩試劑剩餘數量即時資訊</h1>
<div id="query">
<select id="city"></select>
<select id="town"></select>
<input id="okBtn" type="button" value="查詢" /><br/>
鄰近: <input id="btn1K" type="button" value="1.5" />
<input id="btn3K" type="button" value="3" />
<input id="btn5K" type="button" value="5" />
<input id="btn10K" type="button" value="10" /> km
</div>
<div id="cont">
</div>
<footer><span id="note">以上資訊取自健保署，資料即時性與正確性或有落差，請不時刷新本網站，並注意備註欄提醒，備註欄內容由藥局自行維護。</span><br/>
網站製作: <a href="https://www.im.ncnu.edu.tw/">暨大資管系<a>
&nbsp;&nbsp;&nbsp;&nbsp;
資料來源: <a href="https://data.nhi.gov.tw/">健保署</a></footer>
</main>
</body>
</html>