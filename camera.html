<script type="text/javascript" src="led.js" charset="UTF-8"></script>
<!DOCTYPE html>
<html>
  <head>
    <title>Camera</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8">
    <style>
      body {
        margin: 0px;
        height: 100%;
        background-color:rgb(67, 67, 67);
      }
      main {
        position: fixed;
        width: 100%;
        height: 100%;
      }
      ::-webkit-scrollbar {
        display: none;
      }
    </style>
  </head>
  <body>

    <video id="videoElement" width="300" height="200" hidden="true" style="background-color: #707000; opacity: 1.0;" autoplay></video>
    
    <canvas id="canvas" width="400" height="200"></canvas>
    
    <script>

      var video = document.getElementById('videoElement');
      var canvas = document.getElementById('canvas');
      var ctx = canvas.getContext('2d');

      function init() {
          canvas = document.getElementById('canvas');
          canvas.width  = window.innerWidth;
          canvas.height = window.innerHeight;
          ctx = canvas.getContext('2d');
          ledinit();
      }

      function ledinit() {
        side = 3;
        dots = 5;
        makeRound = true;
        initLED(0, 0, canvas.width, canvas.height);
        newLEDMask();
      }

      function ledGo() {
        ledAction4Still(canvas, ctx);
      }
      

      window.addEventListener('resize', function() {
        init();
      });

      function drawVideoFrame() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'rgb(0, 128, 0)';
        ctx.fillRect (0, 0, canvas.width, canvas.height);
        //console.log('( '+video.width + ', ' + video.height + ')');
        let vw = video.videoWidth;
        let vh = video.videoHeight;
        let ratio = vw/vh;
        let _ratio = canvas.width/canvas.height;
        
        if (ratio > _ratio) {  //camera寬 canvas 方
          let cw = canvas.width
          let ch = canvas.width/ratio;//canvas.width * video.height/video.width;
          ctx.drawImage(video, 0, 0, vw, vh,
                               (canvas.width-cw)/2, (canvas.height-ch)/2, cw, ch);
        } else {
          //console.log(""+video.width+", "+video.height+"");
          let cw = canvas.height * ratio;
          let ch = canvas.height;//canvas.width * video.height/video.width;
          ctx.drawImage(video, 0, 0, vw, vh,
                               (canvas.width-cw)/2, (canvas.height-ch)/2, cw, ch);
          
        }
        ledGo();
        requestAnimationFrame(drawVideoFrame);
      }

      document.getElementById('videoElement').addEventListener('canplay', () => {
        init();
        requestAnimationFrame(drawVideoFrame);
        //var videoElement = document.getElementById('videoElement');
        //alert("(" + videoElement.width + ", " + videoElement.height + ")");
      });
      // 取得視訊鏡頭畫面
      //if ('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices)
      navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
          var videoElement = document.getElementById('videoElement');
          videoElement.srcObject = stream;
          //alert("(" + videoElement.width + ", " + videoElement.height + ")");
        }).catch(function(error) {
          console.error('取得視訊鏡頭畫面失敗：', error);
        });

    </script>

  </body>
</html>