<!DOCTYPE html>
<html>

<body>
    <h3>Canvas Receiver</h3>
    <video id="v" autoplay playsinline></video>

    <script>
        const video = document.getElementById("v");

        const pc = new RTCPeerConnection({
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        });

        pc.ontrack = e => {
            console.log('ontrack');
            video.srcObject = e.streams[0];
        };

        let serverDomain = window.location.hostname;
        let port = 80;
        if (window.location.protocol === 'https:') {
            port = 443;
        } else {
            if (window.location.port.length > 0) {
                port = parseInt(window.location.port, 10);
            }
        }

        // WebSocket signaling
        const ws = port == 443 ?
            new WebSocket(`wss://${serverDomain}/Webrtc`) :
            new WebSocket(`ws://${serverDomain}:${port}/Webrtc`);



        pc.onicecandidate = e => {
            console.log('onicecandidate');
            if (e.candidate) {
                ws.send(JSON.stringify({ ice: e.candidate }));
            }
        };

        ws.onmessage = async e => {

            console.log('onmessage');

            const msg = JSON.parse(e.data);

            if (msg.sdp) {
                await pc.setRemoteDescription(msg.sdp);
                if (msg.sdp.type === "offer") {
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    ws.send(JSON.stringify({ sdp: pc.localDescription }));
                }
            }

            if (msg.ice) {
                await pc.addIceCandidate(msg.ice);
            }
        };
    </script>
</body>

</html>