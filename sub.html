<!DOCTYPE html>
<script type="text/javascript" charset="UTF-8">

  const tabCount = 7;

  var tool_Bible = 'subtitle_b.html';
  var tool_index = 'tools.html';//'effect.html';
  
  /*
  const URL_HELP = 'https://docs.google.com/presentation/d/e/2PACX-1vTACMqqdWpFOdQYp1x518Gl7Oy_AQdSHFsSewEcVFOF9LkxKO6d7SCTJl5mkgqPg291kcSEI9vPNq4b/embed?start=false&loop=false';
  //var demo = 'https://docs.google.com/presentation/d/e/2PACX-1vQF2IcPH9tSgDnQVPQm_EbE_ZXAHZj-9lX4-Gb9zsdAhlyiC8LhQrTwHs0f-5OZ2g/embed?start=false&loop=false&delayms=3000';
  var ppt = [URL_HELP,
             '', 
             '', 
             ''];
  var pptype = [0, 0, 0, 0];
  */
  
</script>
<html>
<head>
  <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" charset="UTF-8"/>
  <style>
  body {
    margin: 0px;
    height: 100%;
    width: 100%;
    background-color: green;
  }
  ::-webkit-scrollbar {
    display: none;
  }
  input[type=text] {
        width:60%;
        border:2px solid #0d0;
        border-radius: 4px;
        margin: 2% 2%;
        outline: none;
        padding: 8px;
        box-sizing: border-box;
  }
  input[type=text]:focus {
        border-color: #00ff00;
        box-shadow: 0 0 8px 0 #007000;
  }
  ::selection {
    color: #007000;
    background: #00ff00;
    border-color: #00ff00;
    box-shadow: 0 0 8px 0 #007000;
  }
  .select {
            font-size: 28px;
            height: 40px;
            border: none;
            border-radius: 3px;
            vertical-align: middle;
            margin: 2% 2%;
            color: #00ff00;

        }
  .wrapper {
    display: grid;
    gap: 0px;
    grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 22fr 1fr 1fr 1fr;
    grid-template-rows: 1fr 100fr;
    width: 100%;
    height: 100vh;
  }
  .ctrl {
    grid-column: 1 / 12;
    grid-row: 1 / 2;
    background-color: #007000;
    z-index: 90;
  }
  .content {
    grid-column: 1 /12;
    grid-row: 1 / 3;
  }
  .button {
    font-size: 16px;
    background-color:transparent;
    color: #00ff00;
    width: 50px;
    height:100%;
    border: none;
    vertical-align: middle;
  }
  .okbutton {
      font-size: 16px;
      background-color:rgb(0, 100, 0);
      color: #00ff00;
      width: 60px;
      height: 75%;
      border: 1px;
  }
  </style>
</head>
<body>

<div class="wrapper" style="background-color: #007000; opacity: 1.0;">
  
  <div id="content_f1" class="content" style="background-color: transparent;margin: 0px;opacity: 1.0;">
    <iframe id="frame_f1" frameborder="0" width="100%" height="100%" align="left" src=""></iframe>
      <!--script type="text/javascript" charset="UTF-8">
        document.getElementById("frame_f1").src = tool_index;
      </script-->
  </div>

  <div id="content_f2" class="content" style="background-color: transparent;margin: 0px;opacity: 1.0;">
    <iframe id="frame_f2" frameborder="0" width="100%" height="100%" align="right" src=""></iframe>
      <!--script type="text/javascript" charset="UTF-8">
        document.getElementById("frame_f2").src = tool_index;
      </script-->
  </div>

  <div id="content_f3" class="content" style="background-color: transparent;margin: 0px;opacity: 1.0;">
    <iframe id="frame_f3" frameborder="0" width="100%" height="100%" align="right" src=""></iframe>
      <!--script type="text/javascript" charset="UTF-8">
        document.getElementById("frame_f3").src = tool_index;
      </script-->
  </div>

  <div id="content_f4" class="content" style="background-color: transparent;margin: 0px;opacity: 1.0;">
    <iframe id="frame_f4" frameborder="0" width="100%" height="100%" align="right" src=""></iframe>
    <!--script type="text/javascript" charset="UTF-8">
      document.getElementById("frame_f4").src = tool_index;
    </script-->
  </div>

  <div id="content_f5" class="content" style="background-color: transparent;margin: 0px;opacity: 1.0;">
    <iframe id="frame_f5" frameborder="0" width="100%" height="100%" align="right" src=""></iframe>
    <!--script type="text/javascript" charset="UTF-8">
      document.getElementById("frame_f5").src = tool_index;
    </script-->
  </div>

  <div id="content_f6" class="content" style="background-color: transparent;margin: 0px;opacity: 1.0;">
    <iframe id="frame_f6" frameborder="0" width="100%" height="100%" align="right" src=""></iframe>
    <!--script type="text/javascript" charset="UTF-8">
      document.getElementById("frame_f6").src = tool_index;
    </script-->
  </div>

  <div id="content_f7" class="content" style="background-color: transparent;margin: 0px;opacity: 1.0;">
    <iframe id="frame_f7" frameborder="0" width="100%" height="100%" align="right" src=""></iframe>
    <!--script type="text/javascript" charset="UTF-8">
      document.getElementById("frame_f7").src = tool_index;
    </script-->
  </div>

  <div class="ctrl" id="ctrlBtns">
    <button id="btn_f1" class="button" onclick="switchFunction('f1')">1</button>
    <button id="btn_f2" class="button" onclick="switchFunction('f2')">2</button>
    <button id="btn_f3" class="button" onclick="switchFunction('f3')">3</button>
    <button id="btn_f4" class="button" onclick="switchFunction('f4')">4</button>
    <button id="btn_f5" class="button" onclick="switchFunction('f5')">5</button>
    <button id="btn_f6" class="button" onclick="switchFunction('f6')">6</button>
    <button id="btn_f7" class="button" onclick="switchFunction('f7')">7</button>
    &nbsp;
    &nbsp;
    <button class="okbutton" onclick="openCtrl()">c</button>
    <button id="oxBtn" class="okbutton" onclick="startRestoreInterval()">o</button>
    &nbsp;
    &nbsp;
    <button class="okbutton" onclick="preload('./json_master.json')">#1</button>
    <button class="okbutton" onclick="preload('./json_slave.json')">#2</button>
    <button class="okbutton" onclick="preload('./json_proj.json')">#3</button>
    <button class="okbutton" onclick="loadJson()">#</button>
    <button class="okbutton" onclick="downloadExpJson()">exp</button>
    <button class="okbutton" onclick="reloadFrame()">R</button>
    <input id="jsonfile" type="file" accept=".json" hidden="true" onchange="selectSetting(event)"/>
    <!--button class="okbutton" hidden onclick="current2Json()">export</button-->    
  </div>
  
</div>


</body>
</html>

<script type="text/javascript" charset="UTF-8">

function resetFrame() {
  for (let i=1;i<=tabCount;i++) 
    document.getElementById('frame_f'+i).src = tool_index;
}

function reloadFrame() {
  
  let src = document.getElementById('frame_'+tab).getAttribute('src');
  //console.log('tab:' + tab + ': ' + src);
  document.getElementById('frame_'+tab).setAttribute('src', src);

}

function toObj() {
  let obj = {}
  for (let i=1;i<=tabCount;i++) {
    obj['frame_f'+i] = {};
    let frameObj = obj['frame_f'+i];
    frameObj['src'] = document.getElementById('frame_f'+i).src;
    frameObj['obj'] = {};
    try {
      let _obj = document.getElementById('frame_f'+i).contentWindow.toObj();
      if (_obj) {
        frameObj['obj'] = _obj;
      }
    } catch (e) {
      //frameObj['obj'] = { "url" : "xx" }
    }
  }
  return obj;
}

function downloadExpJson() {
  let str = JSON.stringify(toObj(), null, "\t");
  console.log(str);
  var downloadLink = document.createElement("a");
  downloadLink.setAttribute("href", "data:text/plain;charset=utf-8," + str);
  downloadLink.setAttribute("download", "json_setting.json"); // 设置下载文件的名称，此处为myFile.txt
  // 4. 使用JavaScript模拟用户点击下载链接，从而触发下载
  downloadLink.click();
}



function preload(url) {
  fetch(url).then((response) => { // 
        return response.json();
    }).then( (json) => {
        //console.log(json);//http://localhost/list.json
        handleProfile(json);
    }).catch((error) => {
      alert('Error' + error);
      console.log(`Error: ${error}`);
      getSongsFromList();
    });
}

function loadJson() {
  document.getElementById('jsonfile').click();
}

function handleProfile(jsonData) {
  //const fileContent = event.target.result;
  //const jsonData = JSON.parse(fileContent);
  //console.log(fileContent);
  resetFrame();
  for (let i=1;i<=tabCount;i++) {
      let _f = 'frame_f' + i;
      if (!jsonData[_f]) continue;
      let frame = document.getElementById(_f);
      if (jsonData[_f]['src'])
        frame.src = jsonData[_f]['src'];
      else 
        continue;
      if (jsonData[_f]['obj']) 
        frame.onload = function() { 
          frame.contentWindow.postMessage(JSON.stringify(jsonData[_f]['obj']), '/'); 
        } 
  }
  switchFunction('f1');
}

function selectSetting(event) {
  const inputFile = document.getElementById('jsonfile');
  if (inputFile.files.length == 0) return;
  // 讀取使用者選擇的檔案
  const file = inputFile.files[0];
  const reader = new FileReader();
  reader.readAsText(file);
  // 當讀取完成時，將檔案內容轉換成 JSON 物件並進行處理
  reader.onload = function(event) {
    const fileContent = event.target.result;
    const jsonData = JSON.parse(fileContent);
    console.log(fileContent);
    handleProfile(jsonData);
  }

}

var _openWin = null;
function openCtrl() {
  
  if (_openWin) _openWin.close();
  _openWin = window.open("sub_ctrl.html", "", "popup=no,toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=no,resizable=no,width=64,height=200,top="+(screen.height-400)+",left="+(screen.width-840));
  //window.focus();
  //let div = document.getElementById('ctrlBtns');
  //div.hidden = true;

  /*
  _openWin.addEventListener('beforeunload', (event) => { //'onbeforeunload',
    document.getElementById('ctrlBtns').hidden = false;
    event.preventDefault();
    event.returnValue = '';
  });
  */
}

var action = '';
var tab;
var funcInterval;
var intervalType = 0;

function startRestoreInterval() {

  if (funcInterval) {
    stopTabInterval();
    return;
  }

  funcInterval = window.setInterval(restoreTabFromLocal, 500);
  intervalType = -1;

  var b = document.getElementById('oxBtn');
  b.textContent = 'x';

  for(let i=1;i<=tabCount;i++) {
    if (document.getElementById("frame_f"+i).contentWindow)
      document.getElementById("frame_f"+i).contentWindow.postMessage('x', '/');
  }

}

function stopTabInterval() {
  if (funcInterval) clearInterval(funcInterval);
  funcInterval = null;
  intervalType = 0;

  var b = document.getElementById('oxBtn');
  b.textContent = 'o';

  for(let i=1;i<=tabCount;i++) {
    if (document.getElementById("frame_f"+i).contentWindow)
      document.getElementById("frame_f"+i).contentWindow.postMessage('o', '/');
  }

}

function saveAction2Local(act) {
  
  var date = new Date();

  let h = date.getHours() % 12;
  let min = date.getMinutes();
  let s = date.getSeconds();
  let ms = date.getMilliseconds();

  let key = 'save act';
  let value = act + ' ' + h + ':' + min +':' + s + ':' + ms;
  localStorage.setItem(key, value);

}

function saveTab2Local() {
  let key = 'save tab';
  let value = '' + tab;
  localStorage.setItem(key, value);
}

function restoreTabFromLocal() {

  let actkey = 'save act';
  let actvalue = localStorage.getItem(actkey);
  if (actvalue && actvalue.trim().length > 0) {
    actvalue = actvalue.trim();
    //if (action != actvalue) somelayout();
    action = actvalue;
  } 

  let key = 'save tab';
  let value = localStorage.getItem(key);
  
  if (!value) return;
  
  value = value.trim();
  
  if (value && value.length == 0) return;
  
  let _tab = value;//parseInt(value);

  if (_tab == tab) return;

  tab = _tab;
  _switchFunction(_tab);

}

function switchFunction(idx) {
  tab = idx;
  _switchFunction(idx);
  if (keylock) return;
  saveTab2Local(); 
}

function _switchFunction(idx) {
      
  for(let i=1;i<=tabCount;i++) {
    document.getElementById('content_f' + i).hidden = true;
    document.getElementById('btn_f' + i).style.background = "rgb(0,112,0)";
  }
  document.getElementById('btn_'+idx).style.background = "rgb(0,128,0)";
  document.getElementById('content_'+idx).hidden = false;
  document.getElementById('frame_'+idx).focus();
  return document.getElementById('frame_'+idx);

}

resetFrame();
switchFunction('f1');

var keylock = false;

window.addEventListener('keyup', function(e) {
  if (e.keyCode == 16) keylock = false;
}, false);

window.addEventListener('keydown', function(e) {
  if (e.keyCode == 16) keylock = true;
}, false);

function showPane(elm, show) {
  //div.hidden = !show;
  if (show) {
    elm.style.opacity = '0.8';
  } else {
    elm.style.opacity = '0.0';
  }
}

let div = document.getElementById("ctrlBtns");
div.addEventListener('mouseenter', e => {
  showPane(div, true);
});
div.addEventListener('mouseleave', e => {
  showPane(div, false);
});

window.addEventListener('message', function(event) {

  console.log('message: ' + event);
  
  let frame = document.getElementById('frame_' + tab);
  frame.src = event.data;

});

</script>
